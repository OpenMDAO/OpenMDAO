% s
    <!-- insert awesomplete css below this line -->
    <style type="text/css">
        % s
    </style>
    <style type="text/css">
        @font-face {
            /* Subset of fonts from Font Awesome v4.6.3 created using http://fontello.com/ */
            font-family: 'fontello';
            src: url('data:application/font-woff;charset=utf-8;base64,%s') format('woff');
        }
        [class^="icon-"]:before, [class*=" icon-"]:before {
            display: inline-block;
            font: normal normal normal 14px/1 fontello;
            font-size: inherit;
            text-rendering: auto;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* makes the font 33%% larger relative to the icon container */
        .bigger-font {
            font-size: 1.33333333em;
            line-height: 0.75em;
            vertical-align: -15%%;
        }
        .icon-resize-full:before { content: '\e800'; }
        .icon-resize-small:before { content: '\e801'; }
        .icon-left-big:before { content: '\e802'; }
        .icon-text-height:before { content: '\e803'; }
        .icon-right-big:before { content: '\e804'; }
        .icon-up-big:before { content: '\e805'; }
        .icon-home:before { content: '\e806'; }
        .icon-floppy:before { content: '\e807'; }
        .icon-resize-vertical:before { content: '\e808'; }
        .icon-search:before { content: '\e809'; }
        .icon-exchange:before { content: '\f0ec'; }
        .icon-terminal:before { content: '\f120'; }
        .icon-help:before { content: '\f128'; }
        .icon-eraser:before { content: '\f12d'; }
        .icon-sort-number-up:before { content: '\f162'; }
        .icon-right:before { content: '\f178'; }
        .icon-map-signs:before { content: '\f277'; }
    </style>
    <style type="text/css">
        .myButton {
            background-color:#f9f9f9;
            -moz-border-radius:4px;
            -webkit-border-radius:4px;
            border-radius:4px;
            border:1px solid #aaa;
            display:inline-block;
            cursor:pointer;
            color:#666666;
            font-size:16px;
            text-align: center;
            text-decoration:none;
            width: 30px;
            max-width: 30px;
            height: 30px;
            max-height: 30px;
            margin: 2px 1px 2px 1px;
        }
        .myButton:disabled {
            background-color:#fff;
            color: #bbb;
            cursor:auto;
        }
        .myButton:hover:enabled {
            background-color:#e9e9e9;
        }
        .myButton:active:enabled {
            position:relative;
            top:1px;
        }
        .myButton:focus {
            outline:0;
        }
        .myButtonToggledOn, .myButtonToggledOn:hover:enabled{
            background-color:yellow;
            color:red;
        }

        .toolbar {
            display: inline-block;
            border: 2px solid #aaa;
            box-sizing: border-box;
        }
        .button-group {
            display: inline-block;
        }
        .button-group+.button-group {
            border-left: 2px solid #aaa;
            padding-left: 2px;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        }
        .dropdown-content span.fakeLink {
            font-family: helvetica, sans-serif;
            font-size: 16px;
            cursor: pointer;
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }
        .dropdown-content span.fakeLink:hover {
            background-color: #ddd
        }
        .dropdown:hover .dropdown-content {
            display: block;
            z-index: 100;
        }
        .dropdown:hover .dropbtn {
            background-color: #3e8e41;
        }





        body {
            font-family: helvetica, sans-serif;
        }
        .path_string {
            font-family: "Courier New", Courier;
            font-size: 18px;
            margin-left: 10px;
            margin-top: 20px;
        }
        .ptN2ChartClass {
            margin-left: 10px;
            margin-top: 20px;
        }
        .ptN2LegendClass {
            margin-left: 10px;
            margin-top: 60px;
        }



        /* The Modal (background) */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 9999; /* Sit on top */
            padding-top: 100px; /* Location of the box */
            left: 0;
            top: 0;
            width: 100%%; /* Full width */
            height: 100%%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }
        /* Modal Content */
        .modal-content {
            font-family: helvetica, sans-serif;
            font-size: 14px;
            position: relative;
            background-color: #fefefe;
            margin: auto;
            padding: 0;
            border: 1px solid #888;
            width: 80%%;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
            -webkit-animation-name: animatetop;
            -webkit-animation-duration: 0.4s;
            animation-name: animatetop;
            animation-duration: 0.4s
        }
        /* Add Animation */
        @-webkit-keyframes animatetop {
            from {top:-300px; opacity:0}
            to {top:0; opacity:1}
        }
        @keyframes animatetop {
            from {top:-300px; opacity:0}
            to {top:0; opacity:1}
        }
        /* The Close Button */
        .close {
            color: white;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-header {
            font-family: helvetica, sans-serif;
            font-size: 20px;
            padding: 2px 16px;
            background-color: steelblue;
            color: white;
            margin: 2px;
            padding: 10px;
        }
        .modal-body {padding: 2px 16px;}
        .modal-footer {
            font-family: helvetica, sans-serif;
            font-size: 12px;
            padding: 2px 16px;
            background-color: steelblue;
            color: white;
            margin: 2px;
            padding: 10px;
        }
    </style>
    <div id="all_pt_n2_content_div">
        <div id="maintitle"%s>
            <h1>OpenMDAO Partition Tree and N^2 diagram.</h1>
        </div>
        <div id="ptN2ContentDivId"></div>
    </div>
    <!-- insert d3 library below this line -->
    % s

    <!-- insert awesomplete library below this line -->
    <script type="text/javascript">
        % s
    </script>

    <script type="text/javascript">
        /**
        * vkBeautify - javascript plugin to pretty-print or minify text in XML, JSON, CSS and SQL formats.
        *
        * Version - 0.99.00.beta
        * Copyright (c) 2012 Vadim Kiryukhin
        * vkiryukhin @ gmail.com
        * http://www.eslinstructor.net/vkbeautify/
        *
        * MIT license:
        *   http://www.opensource.org/licenses/mit-license.php
        *
        *   Pretty print
        *
        *        vkbeautify.xml(text [,indent_pattern]);
        *
        *
        *        @text - String; text to beatufy;
        *        @indent_pattern - Integer | String;
        *                Integer:  number of white spaces;
        *                String:   character string to visualize indentation ( can also be a set of white spaces )
        */

        (function() {

            function createShiftArr(step) {

                var space = '    ';

                if ( isNaN(parseInt(step)) ) {  // argument is string
                    space = step;
                } else { // argument is integer
                    switch(step) {
                        case 1: space = ' '; break;
                        case 2: space = '  '; break;
                        case 3: space = '   '; break;
                        case 4: space = '    '; break;
                        case 5: space = '     '; break;
                        case 6: space = '      '; break;
                        case 7: space = '       '; break;
                        case 8: space = '        '; break;
                        case 9: space = '         '; break;
                        case 10: space = '          '; break;
                        case 11: space = '           '; break;
                        case 12: space = '            '; break;
                    }
                }

                var shift = ['\n']; // array of shifts
                for(ix=0;ix<100;ix++){
                    shift.push(shift[ix]+space);
                }
                return shift;
            }

            function vkbeautify(){
                this.step = '\t'; // 4 spaces
                this.shift = createShiftArr(this.step);
            };

            vkbeautify.prototype.xml = function(text,step) {

                var ar = text.replace(/>\s{0,}</g,"><")
                             .replace(/</g,"~::~<")
                             .replace(/\s*xmlns\:/g,"~::~xmlns:")
                             .replace(/\s*xmlns\=/g,"~::~xmlns=")
                             .split('~::~'),
                    len = ar.length,
                    inComment = false,
                    deep = 0,
                    str = '',
                    ix = 0,
                    shift = step ? createShiftArr(step) : this.shift;

                    for(ix=0;ix<len;ix++) {
                        // start comment or <![CDATA[...]]> or <!DOCTYPE //
                        if(ar[ix].search(/<!/) > -1) {
                            str += shift[deep]+ar[ix];
                            inComment = true;
                            // end comment  or <![CDATA[...]]> //
                            if(ar[ix].search(/-->/) > -1 || ar[ix].search(/\]>/) > -1 || ar[ix].search(/!DOCTYPE/) > -1 ) {
                                inComment = false;
                            }
                        } else
                        // end comment  or <![CDATA[...]]> //
                        if(ar[ix].search(/-->/) > -1 || ar[ix].search(/\]>/) > -1) {
                            str += ar[ix];
                            inComment = false;
                        } else
                        // <elm></elm> //
                        if( /^<\w/.exec(ar[ix-1]) && /^<\/\w/.exec(ar[ix]) &&
                            /^<[\w:\-\.\,]+/.exec(ar[ix-1]) == /^<\/[\w:\-\.\,]+/.exec(ar[ix])[0].replace('/','')) {
                            str += ar[ix];
                            if(!inComment) deep--;
                        } else
                         // <elm> //
                        if(ar[ix].search(/<\w/) > -1 && ar[ix].search(/<\//) == -1 && ar[ix].search(/\/>/) == -1 ) {
                            str = !inComment ? str += shift[deep++]+ar[ix] : str += ar[ix];
                        } else
                         // <elm>...</elm> //
                        if(ar[ix].search(/<\w/) > -1 && ar[ix].search(/<\//) > -1) {
                            str = !inComment ? str += shift[deep]+ar[ix] : str += ar[ix];
                        } else
                        // </elm> //
                        if(ar[ix].search(/<\//) > -1) {
                            str = !inComment ? str += shift[--deep]+ar[ix] : str += ar[ix];
                        } else
                        // <elm/> //
                        if(ar[ix].search(/\/>/) > -1 ) {
                            str = !inComment ? str += shift[deep]+ar[ix] : str += ar[ix];
                        } else
                        // <? xml ... ?> //
                        if(ar[ix].search(/<\?/) > -1) {
                            str += shift[deep]+ar[ix];
                        } else
                        // xmlns //
                        if( ar[ix].search(/xmlns\:/) > -1  || ar[ix].search(/xmlns\=/) > -1) {
                            str += shift[deep]+ar[ix];
                        }

                        else {
                            str += ar[ix];
                        }
                    }

                return  (str[0] == '\n') ? str.slice(1) : str;
            }


            window.vkbeautify = new vkbeautify();

        })();
    </script>
    <script type="text/javascript">
    function PtN2Diagram(paramParentDiv, paramUniqueId, paramRootJson, paramConnsJson) {
        var parentDiv = paramParentDiv;
        var uniqueId = paramUniqueId;
        var root = paramRootJson;
        var zoomedElement = root;
        var conns = paramConnsJson;

        var FONT_SIZE_PX = 11;
        var svgStyleElement = document.createElement("style");


        var outputNamingType = "Absolute";


        var showParams = false; //default off

        var showPath = false; //default off

        var showLegend = false; //default off



        //color constants
        var CONNECTION_COLOR = "black",
            UNKNOWN_IMPLICIT_COLOR = "orange",
            UNKNOWN_EXPLICIT_COLOR = "#AAA",
            RED_ARROW_COLOR = "salmon",
            GREEN_ARROW_COLOR = "seagreen",
            HIGHLIGHT_HOVERED_COLOR = "blue",
            N2_COMPONENT_BOX_COLOR = "#555",
            N2_BACKGROUND_COLOR = "#eee",
            N2_GRIDLINE_COLOR = "white",
            PT_STROKE_COLOR = "#eee",
            UNKNOWN_GROUP_COLOR = "#888",
            PARAM_COLOR = "Plum",
            PARAM_GROUP_COLOR = "Orchid",
            GROUP_COLOR = "steelblue",
            COMPONENT_COLOR = "DeepSkyBlue",
            COLLAPSED_COLOR = "#555";


        function UpdateSvgCss(){
            var myCssText =
            "rect { " +
            "    stroke: " + PT_STROKE_COLOR + "; " +
            "} " +
            "g.unknown > rect { " +
            "    fill: " + UNKNOWN_EXPLICIT_COLOR + "; " +
            "    fill-opacity: .8; " +
            "} " +
            "g.unknown_implicit > rect { " +
            "    fill: " + UNKNOWN_IMPLICIT_COLOR + "; " +
            "    fill-opacity: .8; " +
            "} " +
            "g.param > rect { " +
            "    fill: " + PARAM_COLOR + "; " +
            "    fill-opacity: .8; " +
            "} " +
            "g.subsystem > rect { " +
            "    cursor: pointer; " +
            "    fill-opacity: .8; " +
            "    fill: " + GROUP_COLOR + "; " +
            "} " +
            "g.component > rect { " +
            "    cursor: pointer; " +
            "    fill-opacity: .8; " +
            "    fill: " + COMPONENT_COLOR + "; " +
            "} " +
            "g.param_group > rect { " +
            "    cursor: pointer; " +
            "    fill-opacity: .8; " +
            "    fill: " + PARAM_GROUP_COLOR + "; " +
            "} " +
            "g.unknown_group > rect { " +
            "    cursor: pointer; " +
            "    fill-opacity: .8; " +
            "    fill: " + UNKNOWN_GROUP_COLOR + "; " +
            "} " +
            "g.minimized > rect { " +
            "    cursor: pointer; " +
            "    fill-opacity: .8; " +
            "    fill: " + COLLAPSED_COLOR + "; " +
            "} " +
            "text { " +
            //"    dominant-baseline: middle; " +
            //"    dy: .35em; " +
            "} " +
            "#svgId"+uniqueId+" g.partition_group > text { " +
            "    text-anchor: end; " +
            "    pointer-events: none; " +
            "    font-family: helvetica, sans-serif; " +
            "    font-size: " + FONT_SIZE_PX +"px; " +
            "} " +
            "/* n2 diagram*/  " +
            "g.component_box > rect { " +
            "    stroke: " + N2_COMPONENT_BOX_COLOR + "; " +
            "    stroke-width: 2; " +
            "    fill: none; " +
            "} " +
            ".bordR1, .bordR2, .bordR3, .bordR4, .ssMid, .grpMid, .svMid, .vsMid, .vMid, .sgrpMid, .grpsMid { " +
            "    stroke: none; " +
            "    stroke-width: 0; " +
            "    fill-opacity: 1; " +
            "} " +
            "[class^=n2_hover_elements] { " +
            "    pointer-events: none; " +
            "} " +
            ".background { " +
            "    fill: " + N2_BACKGROUND_COLOR + "; " +
            "} " +
            ".horiz_line, .vert_line { /*n2 gridlines*/ " +
            "    stroke: " + N2_GRIDLINE_COLOR + "; " +
            "}";

            svgStyleElement.innerHTML = myCssText;
        }


        var widthPTreePx = 1,
            kx=0, ky=0, kx0=0, ky0=0,
            HEIGHT_PX = 600,
            PARENT_NODE_WIDTH_PX = 40,
            MIN_COLUMN_WIDTH_PX = 5,
            SVG_MARGIN = 1,
            TRANSITION_DURATION_FAST = 1000,
            TRANSITION_DURATION_SLOW = 1500,
            TRANSITION_DURATION = TRANSITION_DURATION_FAST,
            xScalerPTree = d3.scaleLinear().range([0, widthPTreePx]),
            yScalerPTree = d3.scaleLinear().range([0, HEIGHT_PX]),
            xScalerPTree0 = null,
            yScalerPTree0 = null,
            LEVEL_OF_DETAIL_THRESHOLD = HEIGHT_PX / 3; //3 pixels

        var sharedTransition;
        var DEFAULT_TRANSITION_START_DELAY = 100;
        var transitionStartDelay = DEFAULT_TRANSITION_START_DELAY;
        var idCounter = 0;
        var d3NodesArray, d3RightTextNodesArrayZoomed = [], d3RightTextNodesArrayZoomedBoxInfo, drawableN2ComponentBoxes;
        var maxDepth = 1;
        var RIGHT_TEXT_MARGIN_PX = 8; // How much space in px (left and) right of text in partition tree

        //N^2 vars
        var WIDTH_N2_PX = HEIGHT_PX,
            PTREE_N2_GAP_PX = 10; //spacing between partition tree and n2 diagram
        var n2Dx = 0, n2Dy = 0, n2Dx0 = 0, n2Dy0 = 0;
        var matrix;
        var gridLines;
        var symbols_scalar,
            symbols_vector,
            symbols_group,
            symbols_scalarScalar,
            symbols_scalarVector,
            symbols_vectorScalar,
            symbols_vectorVector,
            symbols_scalarGroup,
            symbols_groupScalar,
            symbols_vectorGroup,
            symbols_groupVector,
            symbols_groupGroup;
        var backButtonHistory = [], forwardButtonHistory = [];
        var searchCollapsedUndo = [];
        var autoCompleteListNames = [], autoCompleteListPathNames = [];
        var FindRootOfChangeFunction = null;
        var chosenCollapseDepth = -1;
        var updateRecomputesAutoComplete = true; //default


        CreateDomLayout();
        CreateToolbar();

        ///////////////////////////
        //Modal Help Dialog Stuff
        ///////////////////////////
        var modal = parentDiv.querySelector("#myModal"+uniqueId);

        // When the user clicks the button, open the modal
        function DisplayModal() {
            modal.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        parentDiv.querySelector("#idSpanModalClose"+uniqueId).onclick = function() {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        var d3ContentDiv = parentDiv.querySelector("#d3_content_div"+uniqueId);

        var svgDiv = d3.select(d3ContentDiv).append("div")
            .attr("class", "ptN2ChartClass");

        var svg = svgDiv.append("svg:svg")
            .attr("id","svgId"+uniqueId);


        parentDiv.querySelector("#svgId"+uniqueId).appendChild(svgStyleElement);
        UpdateSvgCss();


        var arrowMarker = svg.append("svg:defs").append("svg:marker");


        arrowMarker
            .attr("id", "arrow")
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 5)
            .attr("refY", 0)
            .attr("markerWidth", 1)
            .attr("markerHeight", 1)
            .attr("orient", "auto")
            .append("path")
            .attr("d", "M0,-5L10,0L0,5")
            .attr("class", "arrowHead");



        var n2Group = svg.append("g");

        var pTreeGroup = svg.append("g");

        var n2BackgroundRectR0 = -1, n2BackgroundRectC0 = -1;
        var newConnsDict = {};
        function PrintConnects() {
            var text = "Connections:";
            for (var key in newConnsDict) {
                var d = newConnsDict[key];
                var param = d3RightTextNodesArrayZoomed[d.c],
                    unknown = d3RightTextNodesArrayZoomed[d.r];
                var paramName = (zoomedElement.promotions && zoomedElement.promotions[param.absPathName] !== undefined) ?
                    "<b>" + zoomedElement.promotions[param.absPathName] + "</b>" :
                    ((zoomedElement === root) ? param.absPathName : param.absPathName.slice(zoomedElement.absPathName.length+1));
                var unknownName = (zoomedElement.promotions && zoomedElement.promotions[unknown.absPathName] !== undefined) ?
                    "<b>" + zoomedElement.promotions[unknown.absPathName] + "</b>" :
                    ((zoomedElement === root) ? unknown.absPathName : unknown.absPathName.slice(zoomedElement.absPathName.length+1));

                text += "<br />self.connect(\"" + unknownName + "\", \"" + paramName + "\")";
            }
            parentDiv.querySelector("#connectionId"+uniqueId).innerHTML = text;
        }
        var n2BackgroundRect = n2Group.append("rect")
            .attr("class", "background")
            .attr("width", WIDTH_N2_PX)
            .attr("height", HEIGHT_PX)
            .on("click", function() {
                if(!showParams) return;
                var coords = d3.mouse(this);
                var c = Math.floor(coords[0] * d3RightTextNodesArrayZoomed.length / WIDTH_N2_PX);
                var r = Math.floor(coords[1] * d3RightTextNodesArrayZoomed.length / HEIGHT_PX);
                if(r == c || r < 0 || c < 0 || r >= d3RightTextNodesArrayZoomed.length || c >= d3RightTextNodesArrayZoomed.length) return;
                if(matrix[r + "_" + c] !== undefined) return;

                var param = d3RightTextNodesArrayZoomed[c],
                    unknown = d3RightTextNodesArrayZoomed[r];
                if(param.type !== "param" || unknown.type !== "unknown") return;

                var newClassName = "n2_hover_elements_" + r + "_" + c;
                var selection = n2Group.selectAll("." + newClassName);
                if(selection.size() > 0){
                    delete newConnsDict[r + "_" + c];
                    selection.remove();
                }
                else{
                    newConnsDict[r + "_" + c] = {"r" : r, "c" : c};
                    n2Group.selectAll("path.n2_hover_elements, circle.n2_hover_elements")
                        .attr("class", newClassName);
                }
                PrintConnects();
            })
            .on("mouseover", function() {
                n2BackgroundRectR0 = -1;
                n2BackgroundRectC0 = -1;
                n2Group.selectAll(".n2_hover_elements").remove();
                PrintConnects();
            })
            .on("mouseleave", function() {
                n2BackgroundRectR0 = -1;
                n2BackgroundRectC0 = -1;
                n2Group.selectAll(".n2_hover_elements").remove();
                PrintConnects();
            })
            .on("mousemove", function() {
                if(!showParams) return;
                var coords = d3.mouse(this);
                var c = Math.floor(coords[0] * d3RightTextNodesArrayZoomed.length / WIDTH_N2_PX);
                var r = Math.floor(coords[1] * d3RightTextNodesArrayZoomed.length / HEIGHT_PX);
                if(r == c || r < 0 || c < 0 || r >= d3RightTextNodesArrayZoomed.length || c >= d3RightTextNodesArrayZoomed.length) return;
                if(matrix[r + "_" + c] !== undefined) return;
                if(n2BackgroundRectR0 == r && n2BackgroundRectC0 == c) return;
                //n2Group.selectAll(".n2_hover_elements_" + n2BackgroundRectR0 + "_" + n2BackgroundRectC0).remove();
                n2Group.selectAll(".n2_hover_elements").remove();
                n2BackgroundRectR0 = r;
                n2BackgroundRectC0 = c;

                var lineWidth = Math.min(5, n2Dx * .5, n2Dy * .5);
                arrowMarker.attr("markerWidth", lineWidth * .4)
                    .attr("markerHeight", lineWidth * .4);

                var param = d3RightTextNodesArrayZoomed[c],
                    unknown = d3RightTextNodesArrayZoomed[r];
                if(param.type !== "param" || unknown.type !== "unknown") return;
                if(r > c) { //bottom left
                    DrawPathTwoLines(
                        n2Dx*r, //x1
                        n2Dy*r + n2Dy * .5, //y1
                        n2Dx*c + n2Dx * .5, //left x2
                        n2Dy*r + n2Dy * .5, //left y2
                        n2Dx*c + n2Dx * .5, //up x3
                        n2Dy*c + n2Dy - 1e-2, //up y3
                        "blue", lineWidth, true);
                }
                else if(r < c) { //top right
                    DrawPathTwoLines(
                        n2Dx*r + n2Dx, //x1
                        n2Dy*r + n2Dy * .5, //y1
                        n2Dx*c + n2Dx * .5, //right x2
                        n2Dy*r + n2Dy * .5, //right y2
                        n2Dx*c + n2Dx * .5, //down x3
                        n2Dy*c+1e-2, //down y3
                        "blue", lineWidth, true);
                }
                var leftTextWidthR = d3RightTextNodesArrayZoomed[r].nameWidthPx,
                    leftTextWidthC = d3RightTextNodesArrayZoomed[c].nameWidthPx;
                DrawRect(-leftTextWidthR-PTREE_N2_GAP_PX, n2Dy*r, leftTextWidthR, n2Dy, "blue"); //highlight var name
                DrawRect(-leftTextWidthC-PTREE_N2_GAP_PX, n2Dy*c, leftTextWidthC, n2Dy, "blue"); //highlight var name

                PrintConnects();

                if(newConnsDict[r + "_" + c] === undefined) {
                    var paramName = (zoomedElement.promotions && zoomedElement.promotions[param.absPathName] !== undefined) ?
                        "<b>" + zoomedElement.promotions[param.absPathName] + "</b>" :
                        ((zoomedElement === root) ? param.absPathName : param.absPathName.slice(zoomedElement.absPathName.length+1));
                    var unknownName = (zoomedElement.promotions && zoomedElement.promotions[unknown.absPathName] !== undefined) ?
                        "<b>" + zoomedElement.promotions[unknown.absPathName] + "</b>" :
                        ((zoomedElement === root) ? unknown.absPathName : unknown.absPathName.slice(zoomedElement.absPathName.length+1));

                    parentDiv.querySelector("#connectionId"+uniqueId).innerHTML += "<br /><i style=\"color:red;\">self.connect(\"" + unknownName + "\", \"" + paramName + "\")</i>";
                }
            });

        var n2ElementsGroup = n2Group.append("g"),
            n2GridLinesGroup = n2Group.append("g"),
            n2ComponentBoxesGroup = n2Group.append("g"),
            n2ArrowsGroup = n2Group.append("g"),
            n2DotsGroup = n2Group.append("g");


        function DrawBorder(g,u,v,color,justUpdate){
            var shape1 = justUpdate ? g.select(".bordR1") : g.append("rect").attr("class", "bordR1").style("fill", color);
            var shape2 = justUpdate ? g.select(".bordR2") : g.append("rect").attr("class", "bordR2").style("fill", color);
            var shape3 = justUpdate ? g.select(".bordR3") : g.append("rect").attr("class", "bordR3").style("fill", color);
            var shape4 = justUpdate ? g.select(".bordR4") : g.append("rect").attr("class", "bordR4").style("fill", color);

            shape1.attr("x", -u).attr("y", -v).attr("width", u * 2).attr("height", v * .2);
            shape2.attr("x", -u).attr("y", -v).attr("width", u * .2).attr("height", v * 2);
            shape3.attr("x", u * .8).attr("y", -v).attr("width", u * .2).attr("height", v * 2);
            shape4.attr("x", -u).attr("y", v * .8).attr("width", u * 2).attr("height", v * .2);
        }
        function DrawScalar(g,u,v,color,justUpdate){
            var shape = justUpdate ? g.select(".sMid") : g.append("ellipse").attr("class", "sMid").style("fill", color);
            return shape.attr("rx", u * .6).attr("ry", v * .6);
        }
        function DrawGroup(g,u,v,color,justUpdate){
            DrawBorder(g,u,v,color,justUpdate);
            var shape = justUpdate ? g.select(".gMid") : g.append("rect").attr("class", "gMid").style("fill", color);
            return shape.attr("x", -u*.6).attr("y", -v*.6).attr("width", u*1.2).attr("height", v*1.2);
        }
        function DrawVector(g,u,v,color,justUpdate){
            var shape = justUpdate ? g.select(".vMid") : g.append("rect").attr("class", "vMid").style("fill", color);
            return shape.attr("x", -u*.6).attr("y", -v*.6).attr("width", u*1.2).attr("height", v*1.2);
        }
        function DrawLegendColor(g,u,v,color,justUpdate){
            var shape = justUpdate ? g.select(".colorMid") : g.append("rect").attr("class", "colorMid").style("fill", color);
            return shape.attr("x", -u).attr("y", -v).attr("width", u*2).attr("height", v*2)
                .style("stroke-width", 0).style("fill-opacity", 1);
        }






        var zoomedElement0 = root;
        var lastRightClickedElement = root;

        var enterIndex = 0,
            exitIndex = 0;

        var lastLeftClickedElement = root,
            leftClickIsForward = true,
            lastClickWasLeft = true;

        var filteredWordForAutoCompleteSuggestions = "", filteredWordForAutoCompleteSuggestionsContainsDot = false;
        var filteredWordForAutoCompleteSuggestionsBaseName = "";
        var wordIndex = 0;
        var searchVals0 = [];
        var inDataFunction = true;
        var filterSet = {};
        var callSearchFromEnterKeyPressed = false;


        window.addEventListener("awesomplete-selectcomplete", function(e){
            // User made a selection from dropdown.
            // This is fired after the selection is applied
            SearchInputEventListener(e);
            callSearchFromEnterKeyPressed = false;
            searchAwesomplete.evaluate();
        }, false);

        var numMatches = 0;
        function DoSearch(d, regexMatch, undoList){
            var didMatch = false;
            if(d.children && !d.isMinimized){ //depth first, dont go into minimized children
                for (var i = 0; i < d.children.length; ++i) {
                    if(DoSearch(d.children[i], regexMatch, undoList)) didMatch = true;
                }
            }
            if(d === zoomedElement) return didMatch;
            if (!showParams && d.type === "param") return didMatch;
            if(!didMatch && !d.children && (d.type === "param" || d.type === "unknown")) {
                didMatch = regexMatch.test(d.absPathName);
                if(didMatch) {
                    ++numMatches; //only params and unknowns can count as matches
                }
                else if(undoList) { //did not match and undo list is not null
                    d.varIsHidden = true;
                    undoList.push(d);
                }
            }

            if(!didMatch && d.children && !d.isMinimized && undoList) { //minimizeable and undoList not null
                d.isMinimized = true;
                undoList.push(d);
            }
            return didMatch;
        }

        function CountMatches(){
            searchCollapsedUndo.forEach(function(d){ //auto undo on successive searches
                if(!d.children && (d.type === "param" || d.type === "unknown")) d.varIsHidden = false;
                else d.isMinimized = false;
            });
            numMatches = 0;
            if(searchVals0.length != 0) DoSearch(zoomedElement, GetSearchRegExp(searchVals0), null);
            searchCollapsedUndo.forEach(function(d){ //auto undo on successive searches
                if(!d.children && (d.type === "param" || d.type === "unknown")) d.varIsHidden = true;
                else d.isMinimized = true;
            });
        }

        function SearchButtonClicked(){
            searchCollapsedUndo.forEach(function(d){ //auto undo on successive searches
                if(!d.children && (d.type === "param" || d.type === "unknown")) d.varIsHidden = false;
                else d.isMinimized = false;
            });
            numMatches = 0;
            searchCollapsedUndo = [];
            if(searchVals0.length != 0) DoSearch(zoomedElement, GetSearchRegExp(searchVals0), searchCollapsedUndo);

            FindRootOfChangeFunction = FindRootOfChangeForSearch;
            TRANSITION_DURATION = TRANSITION_DURATION_SLOW;
            lastClickWasLeft = false;
            updateRecomputesAutoComplete = false;
            Update();
        }

        function GetSearchRegExp(searchValsArray){
            var regexStr = "(^" + searchValsArray.join("$|^") + "$)"; //^ starts at beginning of string   $ is end of string
            regexStr = regexStr.replace(/\./g, "\\."); //convert . to regex
            regexStr = regexStr.replace(/\?/g, "."); //convert ? to regex
            regexStr = regexStr.replace(/\*/g, ".*?"); //convert * to regex
            regexStr = regexStr.replace(/\^/g, "^.*?"); //prepend *
            return new RegExp(regexStr, "i"); //case insensitive
        }


        function SearchInputEventListener(e){
            var target = e.target;
            if(target.id === "awesompleteId"+uniqueId) {
                var newVal = target.value.replace(/([^a-zA-Z0-9:_\?\*\s\.])/g, ""); //valid characters AlphaNumeric : _ ? * space .
                if(newVal !== target.value) {
                    //e.stopPropagation();
                    target.value = newVal; //won't trigger new event
                    //searchAwesomplete.evaluate();
                }

                searchVals0 = target.value.split(" ");
                function isValid(value) {
                    return value.length > 0;
                }
                var filtered = searchVals0.filter(isValid);
                searchVals0 = filtered;

                var lastLetterTypedIndex = target.selectionStart - 1;

                var endIndex = target.value.indexOf(" ",lastLetterTypedIndex);
                if(endIndex == -1) endIndex = target.value.length;
                var startIndex = target.value.lastIndexOf(" ",lastLetterTypedIndex);
                if(startIndex == -1) startIndex = 0;
                var sub = target.value.substring(startIndex, endIndex).trim();
                filteredWordForAutoCompleteSuggestions = sub.replace(/([^a-zA-Z0-9:_\.])/g, ""); //valid openmdao character types: AlphaNumeric : _ .



                for(var i=0; i<searchVals0.length; ++i){
                    if(searchVals0[i].replace(/([^a-zA-Z0-9:_\.])/g, "") === filteredWordForAutoCompleteSuggestions){
                        wordIndex = i;
                        break;
                    }
                }

                filteredWordForAutoCompleteSuggestionsContainsDot = (filteredWordForAutoCompleteSuggestions.indexOf(".") != -1);
                searchAwesomplete.list = filteredWordForAutoCompleteSuggestionsContainsDot ? autoCompleteListPathNames : autoCompleteListNames;
                filteredWordForAutoCompleteSuggestionsBaseName = filteredWordForAutoCompleteSuggestionsContainsDot ? filteredWordForAutoCompleteSuggestions.split(".")[0].trim() : "";

                CountMatches();
                parentDiv.querySelector("#searchCountId"+uniqueId).innerHTML = "" + numMatches + " matches";
            }
        }
        window.addEventListener('input', SearchInputEventListener, true);//Use Capture not bubble so that this will be the first input event

        function SearchEnterKeyUpEventListener(e){
            var target = e.target;
            if(target.id === "awesompleteId"+uniqueId) {
                var key = e.which || e.keyCode;
                if (key === 13) { // 13 is enter
                    if(callSearchFromEnterKeyPressed){
                        SearchButtonClicked();
                    }
                }
            }
        }
        window.addEventListener('keyup', SearchEnterKeyUpEventListener, true);//keyup so it will be after the input and awesomplete-selectcomplete event listeners

        function SearchEnterKeyDownEventListener(e){
            var target = e.target;
            if(target.id === "awesompleteId"+uniqueId) {
                var key = e.which || e.keyCode;
                if (key === 13) { // 13 is enter
                    callSearchFromEnterKeyPressed = true;
                }
            }
        }
        window.addEventListener('keydown', SearchEnterKeyDownEventListener, true);//keydown so it will be before the input and awesomplete-selectcomplete event listeners

        var searchInputId = parentDiv.querySelector("#awesompleteId"+uniqueId);
        var searchAwesomplete = new Awesomplete(searchInputId, {
            "minChars": 1,
            "maxItems": 15,
            "list": [],
            "filter": function(text, input) {
                if(inDataFunction) {
                    inDataFunction = false;
                    filterSet = {};
                }
                if(filteredWordForAutoCompleteSuggestions.length == 0) return false;
                if(filterSet.hasOwnProperty(text)) return false;
                filterSet[text] = true;
                if(filteredWordForAutoCompleteSuggestionsContainsDot) return Awesomplete.FILTER_STARTSWITH(text, filteredWordForAutoCompleteSuggestions);
                return Awesomplete.FILTER_CONTAINS(text, filteredWordForAutoCompleteSuggestions);
            },
            "item": function (text, input) {
                return Awesomplete.ITEM(text, filteredWordForAutoCompleteSuggestions);
            },
            "replace": function(text) {
                var newVal = "";
                var cursorPos = 0;
                for(var i=0; i<searchVals0.length; ++i){
                    newVal += ((i == wordIndex) ? text : searchVals0[i]) + " ";
                    if(i == wordIndex) cursorPos = newVal.length - 1;
                }
                this.input.value = newVal;
                parentDiv.querySelector("#awesompleteId"+uniqueId).setSelectionRange(cursorPos,cursorPos);
            },
            "data": function (item/*, input*/) {
                inDataFunction = true;
                if(filteredWordForAutoCompleteSuggestionsContainsDot) {
                    var baseIndex = item.toLowerCase().indexOf("." + filteredWordForAutoCompleteSuggestionsBaseName.toLowerCase() + ".");
                    if(baseIndex > 0) return item.slice(baseIndex+1);
                }
                return item;
            }
        });


        ExpandColonVars(root);
        FlattenColonGroups(root);
        InitTree(root, null, 1);
        ComputeLayout();
        ComputeConnections();
        ComputeMatrixN2();




        var collapseDepthElement = parentDiv.querySelector("#idCollapseDepthDiv"+uniqueId);
        for(var i=2; i<=maxDepth; ++i) {
            var option = document.createElement("span");
            option.className = "fakeLink";
            option.id = "idCollapseDepthOption" + i + "" + uniqueId;
            option.innerHTML = "" + i + "";
            var f = function(idx) {
                return function(){CollapseToDepthSelectChange(idx);};
            }(i);
            option.onclick = f;
            collapseDepthElement.appendChild(option);
        }

        Update();
        SetupLegend();


        function Update() {
            parentDiv.querySelector("#currentPathId"+uniqueId).innerHTML = "PATH: root" + ((zoomedElement.parent) ? "." : "") + zoomedElement.absPathName;

            parentDiv.querySelector("#backButtonId"+uniqueId).disabled = (backButtonHistory.length == 0) ? "disabled" : false;
            parentDiv.querySelector("#forwardButtonId"+uniqueId).disabled = (forwardButtonHistory.length == 0) ? "disabled" : false;
            parentDiv.querySelector("#upOneLevelButtonId"+uniqueId).disabled = (zoomedElement === root) ? "disabled" : false;
            parentDiv.querySelector("#returnToRootButtonId"+uniqueId).disabled = (zoomedElement === root) ? "disabled" : false;




            // Compute the new tree layout.
            ComputeLayout(); //updates d3NodesArray
            ComputeMatrixN2();

            for(var i=2; i<=maxDepth; ++i){
                parentDiv.querySelector("#idCollapseDepthOption" + i + "" + uniqueId).style.display = (i <= zoomedElement.depth) ? "none" : "block";
            }

            if(xScalerPTree0 != null){//not first run.. store previous
                kx0 = kx;
                ky0 = ky;
                xScalerPTree0 = xScalerPTree.copy();
                yScalerPTree0 = yScalerPTree.copy();
            }

            kx = (zoomedElement.x ? widthPTreePx - PARENT_NODE_WIDTH_PX : widthPTreePx) / (1 - zoomedElement.x);
            ky = HEIGHT_PX / zoomedElement.height;
            xScalerPTree.domain([zoomedElement.x, 1]).range([zoomedElement.x ? PARENT_NODE_WIDTH_PX : 0, widthPTreePx]);
            yScalerPTree.domain([zoomedElement.y, zoomedElement.y + zoomedElement.height]).range([0, HEIGHT_PX]);

            if(xScalerPTree0 == null){ //first run.. duplicate
                kx0 = kx;
                ky0 = ky;
                xScalerPTree0 = xScalerPTree.copy();
                yScalerPTree0 = yScalerPTree.copy();

                //Update svg dimensions before ComputeLayout() changes widthPTreePx
                svgDiv.style("width", (widthPTreePx + PTREE_N2_GAP_PX + WIDTH_N2_PX + 2*SVG_MARGIN) + "px")
                    .style("height", (HEIGHT_PX + 2*SVG_MARGIN) + "px");
                svg.attr("width", widthPTreePx + PTREE_N2_GAP_PX + WIDTH_N2_PX + 2*SVG_MARGIN)
                    .attr("height", HEIGHT_PX + 2*SVG_MARGIN);
                n2Group.attr("transform", "translate(" + (widthPTreePx + PTREE_N2_GAP_PX + SVG_MARGIN) + "," + SVG_MARGIN + ")");
                pTreeGroup.attr("transform", "translate(" + SVG_MARGIN + "," + SVG_MARGIN + ")");
            }

            sharedTransition = d3.transition().duration(TRANSITION_DURATION).delay(transitionStartDelay); //do this after intense computation
            transitionStartDelay = DEFAULT_TRANSITION_START_DELAY;

            //Update svg dimensions with transition after ComputeLayout() changes widthPTreePx
            svgDiv.transition(sharedTransition).style("width", (widthPTreePx + PTREE_N2_GAP_PX + WIDTH_N2_PX + 2*SVG_MARGIN) + "px")
                .style("height", (HEIGHT_PX + 2*SVG_MARGIN) + "px");
            svg.transition(sharedTransition).attr("width", widthPTreePx + PTREE_N2_GAP_PX + WIDTH_N2_PX + 2*SVG_MARGIN)
                .attr("height", HEIGHT_PX + 2*SVG_MARGIN);
            n2Group.transition(sharedTransition).attr("transform", "translate(" + (widthPTreePx + PTREE_N2_GAP_PX + SVG_MARGIN) + "," + SVG_MARGIN + ")");
            pTreeGroup.transition(sharedTransition).attr("transform", "translate(" + SVG_MARGIN + "," + SVG_MARGIN + ")");
            n2BackgroundRect.transition(sharedTransition).attr("width", WIDTH_N2_PX).attr("height", HEIGHT_PX);







            var sel = pTreeGroup.selectAll(".partition_group")
                .data(d3NodesArray, function(d) {
                    return d.id;
                });

            var nodeEnter = sel.enter().append("svg:g")
                .attr("class", function(d) {
                    return "partition_group " + GetClass(d);
                })
                .attr("transform", function(d) {
                    return "translate(" + xScalerPTree0(d.x0) + "," + yScalerPTree0(d.y0) + ")";
                })
                .on("click", LeftClick)
                .on("contextmenu", RightClick);


            nodeEnter.append("svg:rect")
                .attr("width", function(d) {
                    return d.width0 * kx0;//0;//
                })
                .attr("height", function(d) {
                    return d.height0 * ky0;
                });

            nodeEnter.append("svg:text")
                .attr("dy", ".35em")
                //.attr("text-anchor", "end")
                .attr("transform", function(d) {
                    var anchorX = d.width0 * kx0 - RIGHT_TEXT_MARGIN_PX;
                    //var anchorX = -RIGHT_TEXT_MARGIN_PX;
                    return "translate(" + anchorX + "," + d.height0 * ky0 / 2 + ")";
                })
                .style("opacity", function(d) {
                    if(d.depth < zoomedElement.depth) return 0;
                    return d.textOpacity0;
                })
                .text(GetText);

            //d3.select(window).on("click", function() {
            //    click(root);
            //});

            var nodeUpdate = nodeEnter.merge(sel).transition(sharedTransition)
                .attr("class", function(d) {
                    return "partition_group " + GetClass(d);
                })
                .attr("transform", function(d) {
                    return "translate(" + xScalerPTree(d.x) + "," + yScalerPTree(d.y) + ")";
                });

            nodeUpdate.select("rect")
                .attr("width", function(d) {
                    return d.width * kx;
                })
                .attr("height", function(d) {
                    return d.height * ky;
                });

            nodeUpdate.select("text")
                .attr("transform", function(d) {
                    var anchorX = d.width * kx - RIGHT_TEXT_MARGIN_PX;
                    return "translate(" + anchorX + "," + d.height * ky / 2 + ")";
                })
                .style("opacity", function(d) {
                    if(d.depth < zoomedElement.depth) return 0;
                    return d.textOpacity;
                })
                .text(GetText);


            // Transition exiting nodes to the parent's new position.
            var nodeExit = sel.exit().transition(sharedTransition)
                .attr("transform", function(d) {
                    return "translate(" + xScalerPTree(d.x) + "," + yScalerPTree(d.y) + ")";
                })
                .remove();

            nodeExit.select("rect")
                .attr("width", function(d) {
                    return d.width * kx;//0;//
                })
                .attr("height", function(d) {
                    return d.height * ky;
                });

            nodeExit.select("text")
                .attr("transform", function(d) {
                    var anchorX = d.width * kx - RIGHT_TEXT_MARGIN_PX;
                    return "translate(" + anchorX + "," + d.height * ky / 2 + ")";
                    //return "translate(8," + d.height * ky / 2 + ")";
                })
                .style("opacity", 0);


            ClearArrowsAndConnects()
            DrawMatrix();
        }

        function ClearArrows(){
            n2Group.selectAll("[class^=n2_hover_elements]").remove();
        }

        function ClearArrowsAndConnects(){
            ClearArrows();
            newConnsDict = {};
            PrintConnects();
        }


        function ExpandColonVars(d) {
            function findNameInIndex(arr, name) {
                for (var i = 0; i < arr.length; ++i) {
                    if (arr[i].name === name) return i;
                }
                return -1;
            }

            function addChildren(originalParent, parent, arrayOfNames, arrayOfNamesIndex, type) {
                if (arrayOfNames.length == arrayOfNamesIndex) return;

                var name = arrayOfNames[arrayOfNamesIndex];

                if (!parent.hasOwnProperty("children")) {
                    parent.children = [];
                }

                var parentI = findNameInIndex(parent.children, name);
                if (parentI == -1) { //new name not found in parent, create new
                    var newObj = {
                        "name": name,
                        "type": type,
                        "splitByColon": true,
                        "originalParent": originalParent
                    };
                    if(type === "param") {
                        parent.children.splice(0,0,newObj);
                    }
                    else {
                        parent.children.push(newObj);
                    }
                    addChildren(originalParent, newObj, arrayOfNames, arrayOfNamesIndex + 1, type);
                } else { //new name already found in parent, keep traversing
                    addChildren(originalParent, parent.children[parentI], arrayOfNames, arrayOfNamesIndex + 1, type);
                }
            }

            if (!d.children) return;
            for (var i = 0; i < d.children.length; ++i) {

                var splitArray = d.children[i].name.split(":");
                if (splitArray.length > 1) {
                    if(!d.hasOwnProperty("subsystem_type") || d.subsystem_type !== "component"){
                        alert("error: there is a colon named object whose parent is not a component");
                        return;
                    }
                    var type = d.children[i].type;
                    d.children.splice(i--, 1);
                    addChildren(d, d, splitArray, 0, type);
                }
            }
            for (var i = 0; i < d.children.length; ++i) {
                ExpandColonVars(d.children[i]);
            }
        }

        function FlattenColonGroups(d){
            if (!d.children) return;
            while(d.splitByColon && d.children && d.children.length == 1 && d.children[0].splitByColon){
                //alert("combine " + d.name + " " + d.children[0].name);
                var child = d.children[0];
                d.name += ":" + child.name;
                d.children = (child.hasOwnProperty("children") && child.children.length >= 1) ? child.children : null; //absorb childs children
                if(d.children == null) delete d.children;
            }
            if (!d.children) return;
            for (var i = 0; i < d.children.length; ++i) {
                FlattenColonGroups(d.children[i]);
            }
        }

        function GetText(d) {
            var retVal = d.name;
            if(outputNamingType === "Promoted" && (d.type === "unknown" || d.type === "param") && zoomedElement.promotions && zoomedElement.promotions[d.absPathName] !== undefined) {
                retVal = zoomedElement.promotions[d.absPathName];
            }
            if(d.splitByColon && d.children && d.children.length > 0) retVal += ":";
            return retVal;
        }

        //Sets parents, depth, and nameWidthPx of all nodes.  Also finds and sets maxDepth.
        function InitTree(d, parent, depth) {
            d.numLeaves = 0; //for nested params
            d.depth = depth;
            d.parent = parent;
            d.id = ++idCounter; //id starts at 1 for if comparision
            d.absPathName = "";
            if(d.parent){ //not root node? d.parent.absPathName : "";
                if(d.parent.absPathName !== ""){
                    d.absPathName += d.parent.absPathName;
                    d.absPathName += (d.parent.splitByColon) ? ":" : ".";
                }
                d.absPathName += d.name;
            }
            if(d.type === "unknown" || d.type === "param") {
                var parentComponent = (d.originalParent) ? d.originalParent : d.parent;
                if(parentComponent.type === "subsystem" && parentComponent.subsystem_type === "component") {
                    d.parentComponent = parentComponent;
                }
                else{
                    alert("error: there is a param or unknown without a parent component!");
                }
            }
            if(d.splitByColon){
                d.colonName = d.name;
                for(var obj = d.parent; obj.splitByColon; obj = obj.parent){
                    d.colonName = obj.name + ":" + d.colonName;
                }
            }
            maxDepth = Math.max(depth, maxDepth);
            if (d.children) {
                for (var i = 0; i < d.children.length; ++i) {
                    var implicit = InitTree(d.children[i], d, depth + 1);
                    if(implicit){
                        d.implicit = true;
                    }
                }
            }
            return (d.implicit) ? true : false;
        }


        function ComputeLayout() {
            var columnWidthsPx = new Array(maxDepth+1).fill(0.0),// since depth is one based
                columnLocationsPx = new Array(maxDepth+1).fill(0.0);

            var textWidthGroup = svg.append("svg:g").attr("class", "partition_group");
            var textWidthText = textWidthGroup.append("svg:text")
                .text("")
                .attr("x", -50); // Put text off screen
            var textWidthTextNode = textWidthText.node();

            var autoCompleteSetNames = {}, autoCompleteSetPathNames = {};

            function PopulateAutoCompleteList(d){
                if(d.children && !d.isMinimized){ //depth first, dont go into minimized children
                    for (var i = 0; i < d.children.length; ++i) {
                        PopulateAutoCompleteList(d.children[i]);
                    }
                }
                if(d === zoomedElement) return;
                if(!showParams && d.type === "param") return;

                var n = d.name;
                if(d.splitByColon && d.children && d.children.length > 0) n += ":";
                if(d.type !== "param" && d.type !== "unknown") n += ".";
                var namesToAdd = [n];

                if(d.splitByColon) namesToAdd.push(d.colonName + ((d.children && d.children.length > 0) ? ":" : ""));

                namesToAdd.forEach(function(name){
                    if(!autoCompleteSetNames.hasOwnProperty(name)) {
                        autoCompleteSetNames[name] = true;
                        autoCompleteListNames.push(name);
                    }
                });

                var localPathName = (zoomedElement === root) ? d.absPathName : d.absPathName.slice(zoomedElement.absPathName.length+1);
                if(!autoCompleteSetPathNames.hasOwnProperty(localPathName)) {
                    autoCompleteSetPathNames[localPathName] = true;
                    autoCompleteListPathNames.push(localPathName);
                }
            }

            function GetTextWidth(s){
                textWidthText.text(s);
                return textWidthTextNode.getBoundingClientRect().width;
            }

            function UpdateTextWidths(d) {
                if( (!showParams && d.type === "param") || d.varIsHidden  ) return;
                d.nameWidthPx = GetTextWidth(GetText(d)) + 2 * RIGHT_TEXT_MARGIN_PX;
                if (d.children) {
                    for (var i = 0; i < d.children.length; ++i) {
                        UpdateTextWidths(d.children[i]);
                    }
                }
            }

            function ComputeColumnWidths(d) {
                var greatestDepth = 0;
                var leafWidthsPx = new Array(maxDepth+1).fill(0.0);

                function DoComputeColumnWidths(d) {
                    if( (!showParams && d.type === "param") || d.varIsHidden  ) return;

                    var heightPx = HEIGHT_PX * d.numLeaves / zoomedElement.numLeaves;
                    d.textOpacity0 = d.hasOwnProperty('textOpacity') ? d.textOpacity : 0;
                    d.textOpacity = (heightPx > FONT_SIZE_PX) ? 1 : 0;
                    var hasVisibleDetail = (heightPx >= 2.0);
                    var widthPx = 1e-3;
                    if(hasVisibleDetail) widthPx = MIN_COLUMN_WIDTH_PX;
                    if(d.textOpacity > 0.5) widthPx = d.nameWidthPx;

                    greatestDepth = Math.max(greatestDepth, d.depth);

                    if(d.children && !d.isMinimized){ //not leaf
                        columnWidthsPx[d.depth] = Math.max(columnWidthsPx[d.depth], widthPx);
                        for (var i = 0; i < d.children.length; ++i) {
                            DoComputeColumnWidths(d.children[i]);
                        }
                    }
                    else{ //leaf
                        leafWidthsPx[d.depth] = Math.max(leafWidthsPx[d.depth], widthPx);
                    }
                }

                DoComputeColumnWidths(d);


                var sum = 0;
                var lastColumnWidth = 0;
                for(var i=leafWidthsPx.length-1; i>=zoomedElement.depth; --i){
                    sum += columnWidthsPx[i];
                    var lastWidthNeeded = leafWidthsPx[i] - sum;
                    lastColumnWidth = Math.max(lastWidthNeeded, lastColumnWidth);
                }
                columnWidthsPx[zoomedElement.depth-1] = PARENT_NODE_WIDTH_PX;
                columnWidthsPx[greatestDepth] = lastColumnWidth;

            }


            function ComputeLeaves(d) {
                if( (!showParams && d.type === "param") || d.varIsHidden  ) {
                    d.numLeaves = 0;
                    return;
                }
                var doRecurse = d.children && !d.isMinimized;
                d.numLeaves = doRecurse ? 0 : 1; //no children: init to 0 because will be added later
                if (!doRecurse) return;

                for (var i = 0; i < d.children.length; ++i) {
                    ComputeLeaves(d.children[i]);
                    d.numLeaves += d.children[i].numLeaves;
                }
            }

            function ComputeNormalizedPositions(d, leafCounter, isChildOfZoomed, earliestMinimizedParent) {
                isChildOfZoomed = (isChildOfZoomed) ? true : (d === zoomedElement);
                if(earliestMinimizedParent == null && isChildOfZoomed){
                    if( (showParams || d.type !== "param") && !d.varIsHidden  ) d3NodesArray.push(d);
                    if(!d.children || d.isMinimized) { //at a "leaf" node
                        if( (showParams || d.type !== "param") && !d.varIsHidden  ) d3RightTextNodesArrayZoomed.push(d);
                        earliestMinimizedParent = d;
                    }
                }
                var node = (earliestMinimizedParent) ? earliestMinimizedParent : d;
                d.rootIndex0 = d.hasOwnProperty('rootIndex') ? d.rootIndex : leafCounter;
                d.rootIndex = leafCounter;
                d.x0 = d.hasOwnProperty('x') ? d.x : 1e-6;
                d.y0 = d.hasOwnProperty('y') ? d.y : 1e-6;
                d.width0 = d.hasOwnProperty('width') ? d.width : 1e-6;
                d.height0 = d.hasOwnProperty('height') ? d.height : 1e-6;
                d.x = columnLocationsPx[node.depth] / widthPTreePx;
                d.y = leafCounter / root.numLeaves;
                d.width = (d.children && !d.isMinimized) ? (columnWidthsPx[node.depth] / widthPTreePx) : 1-node.x;//1-d.x;
                d.height = node.numLeaves / root.numLeaves;
                if( (!showParams && d.type === "param") || d.varIsHidden  ) { //param or hidden leaf leaving
                    d.x = columnLocationsPx[d.parentComponent.depth+1] / widthPTreePx;
                    d.y = d.parentComponent.y;
                    d.width = 1e-6;
                    d.height = 1e-6;
                }

                if(d.children){
                    for (var i = 0; i < d.children.length; ++i) {
                        ComputeNormalizedPositions(d.children[i], leafCounter, isChildOfZoomed, earliestMinimizedParent);
                        if(earliestMinimizedParent == null){ //numleaves is only valid passed nonminimized nodes
                            leafCounter += d.children[i].numLeaves;
                        }
                    }
                }
            }



            UpdateTextWidths(zoomedElement);
            ComputeLeaves(root);
            d3NodesArray = [];
            d3RightTextNodesArrayZoomed = [];

            //COLUMN WIDTH COMPUTATION
            ComputeColumnWidths(zoomedElement);
            // Now the column_width array is relative to the zoomedElement
            //    and the computation of the widths only includes visible items after the zoom
            widthPTreePx = 0;
            for(var depth = 1 ; depth <= maxDepth; ++depth) {
                columnLocationsPx[depth] = widthPTreePx;
                widthPTreePx += columnWidthsPx[depth];
            }

            ComputeNormalizedPositions(root, 0, false, null);
            if(zoomedElement.parent){
                d3NodesArray.push(zoomedElement.parent);
            }

            if(updateRecomputesAutoComplete) {
                autoCompleteListNames = [];
                autoCompleteListPathNames = [];
                PopulateAutoCompleteList(zoomedElement);
            }
            updateRecomputesAutoComplete = true; //default

            enterIndex = exitIndex = 0;
            if(lastClickWasLeft){ //left click
                if(leftClickIsForward){
                    exitIndex = lastLeftClickedElement.rootIndex - zoomedElement0.rootIndex;
                }
                else{
                    enterIndex = zoomedElement0.rootIndex - lastLeftClickedElement.rootIndex;
                }
            }

            textWidthGroup.remove();

        }





        //right click => collapse
        function RightClick(d) {
            if (!d.children) return;
            if (d3.event.button != 2) return;
            if (d.depth > zoomedElement.depth) { //dont allow minimizing on root node
                lastRightClickedElement = d;
                FindRootOfChangeFunction = FindRootOfChangeForRightClick;
                TRANSITION_DURATION = TRANSITION_DURATION_FAST;
                lastClickWasLeft = false;
                Toggle(d);
                Update(d);
            }
            d3.event.preventDefault();
            d3.event.stopPropagation();
        }

        function SetupLeftClick(d){
            lastLeftClickedElement = d;
            lastClickWasLeft = true;
            if(lastLeftClickedElement.depth > zoomedElement.depth){
                leftClickIsForward = true; //forward
            }
            else if(lastLeftClickedElement.depth < zoomedElement.depth){
                leftClickIsForward = false; //backwards
            }
            zoomedElement0 = zoomedElement;
            zoomedElement = d;
            TRANSITION_DURATION = TRANSITION_DURATION_FAST;
        }

        //left click => navigate
        function LeftClick(d) {
            if (!d.children) return;
            if (d3.event.button != 0) return;
            backButtonHistory.push({"el" : zoomedElement});
            forwardButtonHistory = [];
            SetupLeftClick(d);
            Update();
            d3.event.preventDefault();
            d3.event.stopPropagation();
        }

        function BackButtonPressed() {
            if(backButtonHistory.length == 0) return;
            var d = backButtonHistory.pop().el;
            parentDiv.querySelector("#backButtonId"+uniqueId).disabled = (backButtonHistory.length == 0) ? "disabled" : false;
            for (var obj = d; obj != null; obj = obj.parent) { //make sure history item is not minimized
                if (obj.isMinimized) return;
            }
            forwardButtonHistory.push({"el" : zoomedElement});
            SetupLeftClick(d);
            Update();
        }

        function ForwardButtonPressed() {
            if(forwardButtonHistory.length == 0) return;
            var d = forwardButtonHistory.pop().el;
            parentDiv.querySelector("#forwardButtonId"+uniqueId).disabled = (forwardButtonHistory.length == 0) ? "disabled" : false;
            for (var obj = d; obj != null; obj = obj.parent) { //make sure history item is not minimized
                if (obj.isMinimized) return;
            }
            backButtonHistory.push({"el" : zoomedElement});
            SetupLeftClick(d);
            Update();
        }

        function GetClass(d) {
            if (d.isMinimized) return "minimized";
            if (d.type === "param") {
                if(d.children && d.children.length > 0) return "param_group";
                return "param";
            }
            if (d.type === "unknown") {
                if(d.children && d.children.length > 0) return "unknown_group";
                if(d.implicit) return "unknown_implicit";
                return "unknown";
            }
            if (d.type === "root") return "subsystem";
            if(d.type === "subsystem") {
                if(d.subsystem_type === "component") return "component";
                return "subsystem";
            }
            alert("class not found");
        }



        function Toggle(d) {

            if (d.isMinimized)
                d.isMinimized = false;
            else
                d.isMinimized = true;
        }

        function ComputeConnections() {
            function GetObjectInTree(d, nameArray, nameIndex) {
                if (nameArray.length == nameIndex) {
                    return d;
                }
                if (!d.children) {
                    return null;
                }

                for (var i = 0; i < d.children.length; ++i) {
                    if (d.children[i].name === nameArray[nameIndex]) {
                        return GetObjectInTree(d.children[i], nameArray, nameIndex + 1);
                    }
                    else {
                        var numNames = d.children[i].name.split(":").length;
                        if(numNames >= 2 && nameIndex + numNames <= nameArray.length){
                            var mergedName = nameArray[nameIndex];
                            for(var j=1; j<numNames; ++j){
                                mergedName += ":" + nameArray[nameIndex+j];
                            }
                            if (d.children[i].name === mergedName) {
                                return GetObjectInTree(d.children[i], nameArray, nameIndex + numNames);
                            }
                        }
                    }
                }
                return null;
            }

            //var numElementsBefore = 0,
            //    numElementsAfter = 0;

            function RemoveDuplicates(d) { //remove redundant elements in every objects' sources and targets arrays
                if (d.children) {
                    for (var i = 0; i < d.children.length; ++i) {
                        RemoveDuplicates(d.children[i]);
                    }
                }

                function unique(elem, pos, arr) {
                    return arr.indexOf(elem) == pos;
                }

                /*if(d.sources){
                    numElementsBefore += d.sources.length;
                    var uniqueArray = d.sources.filter(unique);
                    d.sources = uniqueArray;
                    numElementsAfter += d.sources.length;
                }*/
                if (d.targetsParamView) {
                    //numElementsBefore += d.targetsParamView.length;
                    var uniqueArray = d.targetsParamView.filter(unique);
                    d.targetsParamView = uniqueArray;
                    //numElementsAfter += d.targetsParamView.length;
                }
                if (d.targetsHideParams) {
                    //numElementsBefore += d.targetsHideParams.length;
                    var uniqueArray = d.targetsHideParams.filter(unique);
                    d.targetsHideParams = uniqueArray;
                    //numElementsAfter += d.targetsHideParams.length;
                }
            }

            function AddLeaves(d, objArray) {
                if (d.type !== "param") {
                    objArray.push(d);
                }
                if (d.children) {
                    for (var i = 0; i < d.children.length; ++i) {
                        AddLeaves(d.children[i], objArray);
                    }
                }
            }

            function ClearConnections(d) {
                d.targetsParamView = [];
                d.targetsHideParams = [];
                if (d.children) {
                    for (var i = 0; i < d.children.length; ++i) {
                        ClearConnections(d.children[i]);
                    }
                }
            }

            ClearConnections(root);

            for (var i = 0; i < conns.length; ++i) {
                var srcSplitArray = conns[i].src.split(/\.|:/);
                var srcObj = GetObjectInTree(root, srcSplitArray, 0);
                if(srcObj == null) {
                    alert("error: cannot find connection source " + conns[i].src);
                    return;
                }
                var srcObjArray = [srcObj];
                if (srcObj.type !== "unknown") { //source obj must be unknown
                    alert("error: there is a source that is not an unknown.");
                    return;
                }
                if (srcObj.children) { //source obj must be unknown
                    alert("error: there is a source that has children.");
                    return;
                }
                for (var obj = srcObj.parent; obj != null; obj = obj.parent) {
                    srcObjArray.push(obj);
                }

                var tgtSplitArray = conns[i].tgt.split(/\.|:/);
                var tgtObj = GetObjectInTree(root, tgtSplitArray, 0);
                if(tgtObj == null) {
                    alert("error: cannot find connection target " + conns[i].tgt);
                    return;
                }
                var tgtObjArrayParamView = [tgtObj];
                var tgtObjArrayHideParams = [tgtObj];
                if (tgtObj.type !== "param") { //target obj must be a param
                    alert("error: there is a target that is NOT a param.");
                    return;
                }
                if (tgtObj.children) {
                    alert("error: there is a target that has children.");
                    return;
                }
                AddLeaves(tgtObj.parent, tgtObjArrayHideParams); //contaminate
                for (var obj = tgtObj.parent; obj != null; obj = obj.parent) {
                    tgtObjArrayParamView.push(obj);
                    tgtObjArrayHideParams.push(obj);
                }


                for (var j = 0; j < srcObjArray.length; ++j) {
                    if (!srcObjArray[j].hasOwnProperty('targetsParamView')) srcObjArray[j].targetsParamView = [];
                    if (!srcObjArray[j].hasOwnProperty('targetsHideParams')) srcObjArray[j].targetsHideParams = [];
                    srcObjArray[j].targetsParamView = srcObjArray[j].targetsParamView.concat(tgtObjArrayParamView);
                    srcObjArray[j].targetsHideParams = srcObjArray[j].targetsHideParams.concat(tgtObjArrayHideParams);
                }

                /*for(var j = 0; j < tgtObjArray.length; ++j){
                    if(!tgtObjArray[j].hasOwnProperty('sources')) tgtObjArray[j].sources = [];
                    tgtObjArray[j].sources = tgtObjArray[j].sources.concat(srcObjArray);
                }*/
                var cycleArrowsArray = [];
                if(conns[i].cycle_arrows && conns[i].cycle_arrows.length > 0){
                    var cycleArrows = conns[i].cycle_arrows;
                    for(var j=0; j<cycleArrows.length; ++j){
                        var cycleArrowsSplitArray = cycleArrows[j].split(" ");
                        if(cycleArrowsSplitArray.length != 2){
                            alert("error: cycleArrowsSplitArray length not 2: got " + cycleArrowsSplitArray.length);
                            return;
                        }
                        var splitArray = cycleArrowsSplitArray[0].split(/\.|:/);
                        var arrowBeginObj = GetObjectInTree(root, splitArray, 0);
                        if(arrowBeginObj == null) {
                            alert("error: cannot find cycle arrows begin object " + cycleArrowsSplitArray[0]);
                            return;
                        }
                        splitArray = cycleArrowsSplitArray[1].split(/\.|:/);
                        var arrowEndObj = GetObjectInTree(root, splitArray, 0);
                        if(arrowEndObj == null) {
                            alert("error: cannot find cycle arrows end object " + cycleArrowsSplitArray[1]);
                            return;
                        }
                        cycleArrowsArray.push({"begin":arrowBeginObj, "end": arrowEndObj});
                    }
                }
                if(cycleArrowsArray.length > 0){
                    if (!tgtObj.parent.hasOwnProperty("cycleArrows")) {
                        tgtObj.parent.cycleArrows = [];
                    }
                    tgtObj.parent.cycleArrows.push({"src":srcObj, "arrows": cycleArrowsArray});
                }

            }
            RemoveDuplicates(root);
            //alert(numElementsBefore + " " + numElementsAfter);
        }


        function ComputeMatrixN2() {
            matrix = {};
            if(d3RightTextNodesArrayZoomed.length < LEVEL_OF_DETAIL_THRESHOLD){
                for (var si = 0; si < d3RightTextNodesArrayZoomed.length; ++si) {
                    var srcObj = d3RightTextNodesArrayZoomed[si];
                    matrix[si + "_" + si] = {"r": si, "c": si, "obj": srcObj, "id": srcObj.id + "_" + srcObj.id};
                    var targets = (showParams) ? srcObj.targetsParamView : srcObj.targetsHideParams;
                    for (var j = 0; j < targets.length; ++j) {
                        var tgtObj = targets[j];
                        var ti = d3RightTextNodesArrayZoomed.indexOf(tgtObj);
                        if (ti != -1) {
                            matrix[si + "_" + ti] = {"r": si, "c": ti, "obj": srcObj, "id": srcObj.id + "_" + tgtObj.id}; //matrix[si][ti].z = 1;
                        }
                    }
                    if(showParams && srcObj.type === "param"){
                        var srcParentComponent = (srcObj.originalParent) ? srcObj.originalParent : srcObj.parent;
                        for (var j = si+1; j < d3RightTextNodesArrayZoomed.length; ++j) {
                            var tgtObj = d3RightTextNodesArrayZoomed[j];
                            var tgtParentComponent = (tgtObj.originalParent) ? tgtObj.originalParent : tgtObj.parent;
                            if(srcParentComponent !== tgtParentComponent) break;
                            if(tgtObj.type === "unknown"){
                                var ti = j;
                                matrix[si + "_" + ti] = {"r": si, "c": ti, "obj": srcObj, "id": srcObj.id + "_" + tgtObj.id};
                            }
                        }
                    }
                }
            }
            n2Dx0 = n2Dx;
            n2Dy0 = n2Dy;

            n2Dx = WIDTH_N2_PX / d3RightTextNodesArrayZoomed.length;
            n2Dy = HEIGHT_PX / d3RightTextNodesArrayZoomed.length;


            symbols_scalar = [];
            symbols_vector = [];
            symbols_group = [];
            symbols_scalarScalar = [];
            symbols_scalarVector = [];
            symbols_vectorScalar = [];
            symbols_vectorVector = [];
            symbols_scalarGroup = [];
            symbols_groupScalar = [];
            symbols_vectorGroup = [];
            symbols_groupVector = [];
            symbols_groupGroup = [];

            for (var key in matrix) {
                var d = matrix[key];
                var tgtObj = d3RightTextNodesArrayZoomed[d.c], srcObj = d3RightTextNodesArrayZoomed[d.r];
                //alert(tgtObj.name + " " + srcObj.name);
                if (d.c == d.r) { //on diagonal
                    if (srcObj.type === "subsystem") { //group
                        symbols_group.push(d);
                    } else if (srcObj.type === "unknown" || (showParams && srcObj.type === "param")) {
                        if (srcObj.dtype === "ndarray") { //vector
                            symbols_vector.push(d);
                        } else { //scalar
                            symbols_scalar.push(d);
                        }
                    }

                }
                else if (srcObj.type === "subsystem"){
                    if(tgtObj.type === "subsystem") { //groupGroup
                        symbols_groupGroup.push(d);
                    }
                    else if(tgtObj.type === "unknown" || (showParams && tgtObj.type === "param")){
                        if (tgtObj.dtype === "ndarray"){//groupVector
                            symbols_groupVector.push(d);
                        }
                        else{//groupScalar
                            symbols_groupScalar.push(d);
                        }
                    }
                }
                else if (srcObj.type === "unknown" || (showParams && srcObj.type === "param")){
                    if (srcObj.dtype === "ndarray"){
                        if(tgtObj.type === "unknown" || (showParams && tgtObj.type === "param")) {
                            if (tgtObj.dtype === "ndarray" || (showParams && tgtObj.type === "param")){//vectorVector
                                symbols_vectorVector.push(d);
                            }
                            else{//vectorScalar
                                symbols_vectorScalar.push(d);
                            }

                        }
                        else if(tgtObj.type === "subsystem") { //vectorGroup
                            symbols_vectorGroup.push(d);
                        }
                    }
                    else { //if (srcObj.dtype !== "ndarray"){
                        if(tgtObj.type === "unknown" || (showParams && tgtObj.type === "param")) {
                            if (tgtObj.dtype === "ndarray"){//scalarVector
                                symbols_scalarVector.push(d);
                            }
                            else{//scalarScalar
                                symbols_scalarScalar.push(d);
                            }

                        }
                        else if(tgtObj.type === "subsystem") { //scalarGroup
                            symbols_scalarGroup.push(d);
                        }
                    }

                }
            }



            var currentBox = {"startI":0, "stopI":0};
            d3RightTextNodesArrayZoomedBoxInfo = [currentBox];
            for(var ri=1; ri<d3RightTextNodesArrayZoomed.length; ++ri){
                //boxes
                var el = d3RightTextNodesArrayZoomed[ri];
                var startINode = d3RightTextNodesArrayZoomed[currentBox.startI];
                if(startINode.parentComponent && el.parentComponent && startINode.parentComponent === el.parentComponent) {
                    ++currentBox.stopI;
                }
                else{
                    currentBox = {"startI":ri, "stopI":ri};
                }
                d3RightTextNodesArrayZoomedBoxInfo.push(currentBox);
            }
            //alert(JSON.stringify(d3RightTextNodesArrayZoomedBoxInfo));
            //return;

            drawableN2ComponentBoxes = [];
            for(var i=0; i<d3RightTextNodesArrayZoomedBoxInfo.length; ++i){ //draw grid lines last so that they will always be visible
                var box = d3RightTextNodesArrayZoomedBoxInfo[i];
                if(box.startI == box.stopI) continue;
                var el = d3RightTextNodesArrayZoomed[box.startI];
                if(!el.parentComponent) alert("parent component not found in box"); //continue;
                box.obj = el.parentComponent;
                i=box.stopI;
                drawableN2ComponentBoxes.push(box);
            }


            //do this so you save old index for the exit()
            gridLines = [];
            if(d3RightTextNodesArrayZoomed.length < LEVEL_OF_DETAIL_THRESHOLD){
                for(var i=0; i<d3RightTextNodesArrayZoomed.length; ++i){
                    var obj = d3RightTextNodesArrayZoomed[i];
                    var gl = {"i":i, "obj": obj};
                    gridLines.push(gl);
                }
            }
        }


        function FindRootOfChangeForShowParams(d){
            return (d.hasOwnProperty("parentComponent")) ? d.parentComponent : d;
        }

        function FindRootOfChangeForRightClick(d){
            return lastRightClickedElement;
        }

        function FindRootOfChangeForCollapseDepth(d){
            for (var obj = d; obj != null; obj = obj.parent) { //make sure history item is not minimized
                if (obj.depth == chosenCollapseDepth) return obj;
            }
            return d;
        }

        function FindRootOfChangeForSearch(d){
            var earliestObj = d;
            for (var obj = d; obj != null; obj = obj.parent) {
                if (obj.isMinimized) earliestObj = obj;
            }
            return earliestObj;
        }

        function FindRootOfChangeForCollapseUncollapseOutputs(d){
            return (d.hasOwnProperty("parentComponent")) ? d.parentComponent : d;
        }



        function DrawMatrix() {
            var u0 = n2Dx0 * .5,
                v0 = n2Dy0 * .5,
                u = n2Dx * .5,
                v = n2Dy * .5; //(0,0) = center of cell... (u,v) = bottom right of cell... (-u,-v) = top left of cell



            function GetOnDiagonalCellColor(d) {
                var rt = d3RightTextNodesArrayZoomed[d.c];
                if (rt.isMinimized) return COLLAPSED_COLOR;
                if(rt.type === "param") return PARAM_COLOR;
                return (rt.implicit) ? UNKNOWN_IMPLICIT_COLOR : UNKNOWN_EXPLICIT_COLOR;
            }


            var classes = ["cell_scalar", "cell_vector", "cell_group", "cell_scalarScalar", "cell_scalarVector", "cell_vectorScalar",
                "cell_vectorVector", "cell_scalarGroup", "cell_groupScalar", "cell_vectorGroup", "cell_groupVector", "cell_groupGroup"
            ];
            var datas = [symbols_scalar, symbols_vector, symbols_group, symbols_scalarScalar, symbols_scalarVector, symbols_vectorScalar,
                symbols_vectorVector, symbols_scalarGroup, symbols_groupScalar, symbols_vectorGroup, symbols_groupVector, symbols_groupGroup
            ];
            var drawFunctions = [DrawScalar, DrawVector, DrawGroup, DrawScalar, DrawVector, DrawVector,
                DrawVector, DrawGroup, DrawGroup, DrawGroup, DrawGroup, DrawGroup
            ];
            for(var i=0; i<classes.length; ++i){
                var sel = n2ElementsGroup.selectAll("." + classes[i])
                    .data(datas[i], function(d) {
                        return d.id;
                    });
                var gEnter = sel.enter().append("g")
                    .attr("class", classes[i])
                    .attr("transform", function(d) {
                        if(lastClickWasLeft) return "translate(" + (n2Dx0*(d.c-enterIndex)+u0) + "," + (n2Dy0*(d.r-enterIndex)+v0) + ")";
                        var roc = (d.obj && FindRootOfChangeFunction) ? FindRootOfChangeFunction(d.obj) : null;
                        if(roc) {
                            var index0 = roc.rootIndex0 - zoomedElement.rootIndex0;
                            return "translate(" + (n2Dx0*index0+u0) + "," + (n2Dy0*index0+v0) + ")";
                        }
                        alert("error: enter transform not found");
                    });
                drawFunctions[i](gEnter, u0, v0, (i<3) ? GetOnDiagonalCellColor : CONNECTION_COLOR, false)
                    .on("mouseover", (i<3) ? MouseoverOnDiagN2 : MouseoverOffDiagN2)
                    .on("mouseleave", MouseoutN2)
                    .on("click", MouseClickN2);


                var gUpdate = gEnter.merge(sel).transition(sharedTransition)
                    .attr("transform", function(d) {
                        return "translate(" + (n2Dx*(d.c)+u) + "," + (n2Dy*(d.r)+v) + ")";
                    });
                drawFunctions[i](gUpdate,u,v, (i<3) ? GetOnDiagonalCellColor : CONNECTION_COLOR, true);


                var nodeExit = sel.exit().transition(sharedTransition)
                    .attr("transform", function(d) {
                        if(lastClickWasLeft) return "translate(" + (n2Dx*(d.c-exitIndex)+u) + "," + (n2Dy*(d.r-exitIndex)+v) + ")";
                        var roc = (d.obj && FindRootOfChangeFunction) ? FindRootOfChangeFunction(d.obj) : null;
                        if(roc) {
                            var index = roc.rootIndex - zoomedElement.rootIndex;
                            return "translate(" + (n2Dx*index+u) + "," + (n2Dy*index+v) + ")";
                        }
                        alert("error: exit transform not found");
                    })
                    .remove();
                drawFunctions[i](nodeExit,u,v, (i<3) ? GetOnDiagonalCellColor : CONNECTION_COLOR, true);
            }



            {
                var sel = n2GridLinesGroup.selectAll(".horiz_line")
                    .data(gridLines, function(d) {
                        return d.obj.id;
                    });

                var gEnter = sel.enter().append("g")
                    .attr("class", "horiz_line")
                    .attr("transform", function(d) {
                        if(lastClickWasLeft) return "translate(0," + (n2Dy0*(d.i-enterIndex)) + ")";
                        var roc = (FindRootOfChangeFunction) ? FindRootOfChangeFunction(d.obj) : null;
                        if(roc) {
                            var index0 = roc.rootIndex0 - zoomedElement.rootIndex0;
                            return "translate(0," + (n2Dy0*index0) + ")";
                        }
                        alert("error: enter transform not found");
                    });
                gEnter.append("line")
                    .attr("x2", WIDTH_N2_PX);

                var gUpdate = gEnter.merge(sel).transition(sharedTransition)
                    .attr("transform", function(d) {
                        return "translate(0," + (n2Dy*d.i) + ")";
                    });
                gUpdate.select("line")
                    .attr("x2", WIDTH_N2_PX);


                var nodeExit = sel.exit().transition(sharedTransition)
                    .attr("transform", function(d) {
                        if(lastClickWasLeft) return "translate(0," + (n2Dy*(d.i-exitIndex)) + ")";
                        var roc = (FindRootOfChangeFunction) ? FindRootOfChangeFunction(d.obj) : null;
                        if(roc) {
                            var index = roc.rootIndex - zoomedElement.rootIndex;
                            return "translate(0," + (n2Dy*index) + ")";
                        }
                        alert("error: exit transform not found");
                    })
                    .remove();
            }

            {
                var sel = n2GridLinesGroup.selectAll(".vert_line")
                    .data(gridLines, function(d) {
                        return d.obj.id;
                    });
                var gEnter = sel.enter().append("g")
                    .attr("class", "vert_line")
                    .attr("transform", function(d) {
                        if(lastClickWasLeft) return "translate(" + (n2Dx0*(d.i-enterIndex)) + ")rotate(-90)";
                        var roc = (FindRootOfChangeFunction) ? FindRootOfChangeFunction(d.obj) : null;
                        if(roc) {
                            var i0 = roc.rootIndex0 - zoomedElement.rootIndex0;
                            return "translate(" + (n2Dx0*i0) + ")rotate(-90)";
                        }
                        alert("error: enter transform not found");
                    });
                gEnter.append("line")
                    .attr("x1", -HEIGHT_PX);

                var gUpdate = gEnter.merge(sel).transition(sharedTransition)
                    .attr("transform", function(d) {
                        return "translate(" + (n2Dx*d.i) + ")rotate(-90)";
                    });
                gUpdate.select("line")
                    .attr("x1", -HEIGHT_PX);


                var nodeExit = sel.exit().transition(sharedTransition)
                    .attr("transform", function(d) {
                        if(lastClickWasLeft) return "translate(" + (n2Dx*(d.i-exitIndex)) + ")rotate(-90)";
                        var roc = (FindRootOfChangeFunction) ? FindRootOfChangeFunction(d.obj) : null;
                        if(roc) {
                            var i = roc.rootIndex - zoomedElement.rootIndex;
                            return "translate(" + (n2Dx*i) + ")rotate(-90)";
                        }
                        alert("error: exit transform not found");
                    })
                    .remove();
            }


            {
                var sel = n2ComponentBoxesGroup.selectAll(".component_box")
                    .data(drawableN2ComponentBoxes, function(d) {
                        return d.obj.id;
                    });
                var gEnter = sel.enter().append("g")
                    .attr("class", "component_box")
                    .attr("transform", function(d) {
                        if(lastClickWasLeft) return "translate(" + (n2Dx0*(d.startI-enterIndex)) + "," + (n2Dy0*(d.startI-enterIndex)) + ")";
                        var roc = (d.obj && FindRootOfChangeFunction) ? FindRootOfChangeFunction(d.obj) : null;
                        if(roc) {
                            var index0 = roc.rootIndex0 - zoomedElement.rootIndex0;
                            return "translate(" + (n2Dx0*index0) + "," + (n2Dy0*index0) + ")";
                        }
                        alert("error: enter transform not found");
                    });

                gEnter.append("rect")
                    .attr("width", function(d) {
                        if(lastClickWasLeft) return n2Dx0*(1+d.stopI-d.startI);
                        return n2Dx0;
                    })
                    .attr("height", function(d) {
                        if(lastClickWasLeft) return n2Dy0*(1+d.stopI-d.startI);
                        return n2Dy0;
                    });

                var gUpdate = gEnter.merge(sel).transition(sharedTransition)
                    .attr("transform", function(d) {
                        return "translate(" + (n2Dx*d.startI) + "," + (n2Dy*d.startI) + ")";
                    });

                gUpdate.select("rect")
                    .attr("width", function(d) {
                        return n2Dx*(1+d.stopI-d.startI);
                    })
                    .attr("height", function(d) {
                        return n2Dy*(1+d.stopI-d.startI);
                    });


                var nodeExit = sel.exit().transition(sharedTransition)
                    .attr("transform", function(d) {
                        if(lastClickWasLeft) return "translate(" + (n2Dx*(d.startI-exitIndex)) + "," + (n2Dy*(d.startI-exitIndex)) + ")";
                        var roc = (d.obj && FindRootOfChangeFunction) ? FindRootOfChangeFunction(d.obj) : null;
                        if(roc) {
                            var index = roc.rootIndex - zoomedElement.rootIndex;
                            return "translate(" + (n2Dx*index) + "," + (n2Dy*index) + ")";
                        }
                        alert("error: exit transform not found");
                    })
                    .remove();

                nodeExit.select("rect")
                    .attr("width", function(d) {
                        if(lastClickWasLeft) return n2Dx*(1+d.stopI-d.startI);
                        return n2Dx;
                    })
                    .attr("height", function(d) {
                        if(lastClickWasLeft) return n2Dy*(1+d.stopI-d.startI);
                        return n2Dy;
                    });

            }
        }




        function DrawRect(x, y, width, height, fill) {
            n2Group.insert("rect")
                .attr("class", "n2_hover_elements")
                .attr("y", y)
                .attr("x", x)
                .attr("width", width)
                .attr("height", height)
                .attr("fill", fill)
                .attr("fill-opacity", "1");
        }


        function DrawPathTwoLines(x1, y1, x2, y2, x3, y3, color, width, useArrow) {
            var path = n2ArrowsGroup.insert("path")
                .attr("class", "n2_hover_elements")
                .attr("d", "M" + x1 + " " + y1 + " L" + x2 + " " + y2 + " L" + x3 + " " + y3)
                .attr("fill", "none")
                .style("stroke-width", width)
                .style("stroke", color);

            n2DotsGroup.append("circle")
                .attr("class", "n2_hover_elements")
                .attr("cx", x2)
                .attr("cy", y2)
                .attr("r", width * 1.0)
                .style("stroke-width", 0)
                .style("fill-opacity", 1)
                .style("fill", "black");
            n2DotsGroup.append("circle")
                .attr("class", "n2_hover_elements")
                .attr("cx", x2)
                .attr("cy", y2)
                .attr("r", width * 1.0)
                .style("stroke-width", 0)
                .style("fill-opacity", .75)
                .style("fill", color);

            if (useArrow) {
                path.attr("marker-end", "url(#arrow)");
            }
        }



        function MouseoverOffDiagN2(d){
            function DrawArrowsParamView(startIndex, endIndex) {
                //var leftTextWidthDependency = d3RightTextNodesArrayZoomed[i].nameWidthPx;

                var lineWidth = Math.min(5, n2Dx * .5, n2Dy * .5);
                arrowMarker.attr("markerWidth", lineWidth * .4)
                    .attr("markerHeight", lineWidth * .4);

                var boxStart = d3RightTextNodesArrayZoomedBoxInfo[startIndex];
                var boxEnd = d3RightTextNodesArrayZoomedBoxInfo[endIndex];

                //draw multiple horizontal lines but no more than one vertical line for box to box connections
                var startIndices = [], endIndices = [];
                for(var startsI=boxStart.startI; startsI<=boxStart.stopI; ++startsI){
                    for(var endsI=boxEnd.startI; endsI<=boxEnd.stopI; ++endsI){
                        if(matrix[startsI + "_" + endsI] !== undefined){ //if(matrix[startsI][endsI].z > 0){
                            startIndices.push(startsI);
                            endIndices.push(endsI);
                        }
                    }

                }

                for(var i=0; i<startIndices.length; ++i){
                    var startI = startIndices[i];
                    var endI = endIndices[i];

                    if(startIndex < endIndex){ //right down arrow
                        var x1 = (startI+1)*n2Dx; //x1
                        var x2 = (endI+.5)*n2Dx; //right x2
                        var x3 = x2; //down x3

                        var y1 = (startI+.5)*n2Dy; //y1
                        var y2 = y1; //right y2
                        var y3 = endI*n2Dy; //down y3

                        DrawPathTwoLines(x1, y1, x2, y2, x3, y3, GREEN_ARROW_COLOR, lineWidth, true);

                    }
                    else if(startIndex > endIndex){ //left up arrow
                        //alert("yes");
                        var x1 = startI*n2Dx; //x1
                        var x2 = (endI+.5)*n2Dx; //left x2
                        var x3 = x2; //up x3

                        var y1 = (startI+.5)*n2Dy; //y1
                        var y2 = y1; //left y2
                        var y3 = (endI+1)*n2Dy; //y1

                        DrawPathTwoLines(x1, y1, x2, y2, x3, y3, RED_ARROW_COLOR, lineWidth, true);
                    }
                }
            }

            function DrawArrows(startIndex, endIndex) {
                //var leftTextWidthDependency = d3RightTextNodesArrayZoomed[i].nameWidthPx;

                var lineWidth = Math.min(5, n2Dx * .5, n2Dy * .5);
                arrowMarker.attr("markerWidth", lineWidth * .4)
                    .attr("markerHeight", lineWidth * .4);

                var boxStart = d3RightTextNodesArrayZoomedBoxInfo[startIndex];
                var boxEnd = d3RightTextNodesArrayZoomedBoxInfo[endIndex];

                //draw multiple horizontal lines but no more than one vertical line for box to box connections
                var startIndices = [];
                for(var startsI=boxStart.startI; startsI<=boxStart.stopI; ++startsI){
                    for(var endsI=boxEnd.startI; endsI<=boxEnd.stopI; ++endsI){
                        if(matrix[startsI + "_" + endsI] !== undefined){ //if(matrix[startsI][endsI].z > 0){
                            startIndices.push(startsI);
                            break;
                        }
                    }

                }

                for(var i=0; i<startIndices.length; ++i){
                    var startI = startIndices[i];
                    var boxEndDelta = boxEnd.stopI - boxEnd.startI;

                    if(startIndex < endIndex){ //right down arrow
                        var x1 = (startI+1)*n2Dx; //x1
                        var x2 = (endIndex+boxEndDelta*.5)*n2Dx + n2Dx*.5; //right x2
                        var x3 = x2; //down x3

                        var y1 = startI*n2Dy + n2Dy*.5; //y1
                        var y2 = y1; //right y2
                        var y3 = endIndex*n2Dy; //down y3

                        DrawPathTwoLines(x1, y1, x2, y2, x3, y3, GREEN_ARROW_COLOR, lineWidth, true);

                    }
                    else if(startIndex > endIndex){ //left up arrow
                        //alert("yes");
                        var x1 = startI*n2Dx; //x1
                        var x2 = (endIndex+boxEndDelta*.5)*n2Dx + n2Dx*.5; //left x2
                        var x3 = x2; //up x3

                        var y1 = startI*n2Dy + n2Dy*.5; //y1
                        var y2 = y1; //left y2
                        var y3 = (endIndex+boxEndDelta+1)*n2Dy; //y1

                        DrawPathTwoLines(x1, y1, x2, y2, x3, y3, RED_ARROW_COLOR, lineWidth, true);
                    }
                }
            }

            function GetObjectsInChildrenWithCycleArrows(d, arr) {
                if (d.cycleArrows) {
                    arr.push(d);
                }
                if (d.children) {
                    for (var i = 0; i < d.children.length; ++i) {
                        GetObjectsInChildrenWithCycleArrows(d.children[i], arr);
                    }
                }
            }
            function GetObjectsWithCycleArrows(d, arr) {
                for (var obj = d.parent; obj != null; obj = obj.parent) { //start with parent.. the children will get the current object to avoid duplicates
                    if (obj.cycleArrows) {
                        arr.push(obj);
                    }
                }
                GetObjectsInChildrenWithCycleArrows(d, arr);
            }

            function HasObjectInChildren(d, toMatchObj) {
                if (d === toMatchObj) {
                    return true;
                }
                if (d.children) {
                    for (var i = 0; i < d.children.length; ++i) {
                        if (HasObjectInChildren(d.children[i], toMatchObj)) {
                            return true;
                        }
                    }
                }
                return false;
            }
            function HasObject(d, toMatchObj) {
                for (var obj = d; obj != null; obj = obj.parent) {
                    if(obj === toMatchObj){
                        return true;
                    }
                }
                return HasObjectInChildren(d, toMatchObj);
            }

            //alert("c=" + d.c + "  r=" + d.r);
            var lineWidth = Math.min(5, n2Dx * .5, n2Dy * .5);
            arrowMarker.attr("markerWidth", lineWidth * .4)
                .attr("markerHeight", lineWidth * .4);
            var src = d3RightTextNodesArrayZoomed[d.r];
            var tgt = d3RightTextNodesArrayZoomed[d.c];
            var boxEnd = d3RightTextNodesArrayZoomedBoxInfo[d.c];
            if(d.r > d.c){ //bottom left
                DrawPathTwoLines(
                    n2Dx*d.r, //x1
                    n2Dy*d.r + n2Dy * .5, //y1
                    n2Dx*d.c + n2Dx * .5, //left x2
                    n2Dy*d.r + n2Dy * .5, //left y2
                    n2Dx*d.c + n2Dx * .5, //up x3
                    (showParams) ? n2Dy*d.c + n2Dy - 1e-2 : n2Dy*(boxEnd.stopI) + n2Dy - 1e-2, //up y3
                    RED_ARROW_COLOR, lineWidth, true);

                //tgtObj.parent.cycleArrows.push({"src":srcObj, "arrows": cycleArrowsArray});
                var targetsWithCycleArrows = [];
                GetObjectsWithCycleArrows(tgt, targetsWithCycleArrows);
                for(var ti = 0; ti< targetsWithCycleArrows.length; ++ti){ //if(tgt.parent.cycleArrows){
                    var arrows = targetsWithCycleArrows[ti].cycleArrows;//tgt.parent.cycleArrows;
                    for(var ai=0; ai<arrows.length; ++ai){
                        if(HasObject(src, arrows[ai].src)){ //if(arrows[ai].src === src){
                            var correspondingSrcArrows = arrows[ai].arrows;
                            for(var si=0; si<correspondingSrcArrows.length; ++si){
                                var beginObj = correspondingSrcArrows[si].begin;
                                var endObj = correspondingSrcArrows[si].end;
                                //alert(beginObj.name + "->" + endObj.name);
                                var firstBeginIndex = -1, firstEndIndex = -1;

                                //find first begin index
                                for (var mi = 0; mi < d3RightTextNodesArrayZoomed.length; ++mi) {
                                    var rtNode = d3RightTextNodesArrayZoomed[mi];
                                    if(HasObject(rtNode, beginObj)){
                                        firstBeginIndex = mi;
                                        break;
                                    }
                                }
                                if(firstBeginIndex == -1){
                                    alert("error: first begin index not found");
                                    return;
                                }

                                //find first end index
                                for (var mi = 0; mi < d3RightTextNodesArrayZoomed.length; ++mi) {
                                    var rtNode = d3RightTextNodesArrayZoomed[mi];
                                    if(HasObject(rtNode, endObj)){
                                        firstEndIndex = mi;
                                        break;
                                    }
                                }
                                if(firstEndIndex == -1){
                                    alert("error: first end index not found");
                                    return;
                                }

                                if(firstBeginIndex != firstEndIndex){
                                    if(showParams){
                                        DrawArrowsParamView(firstBeginIndex, firstEndIndex);
                                    }
                                    else {
                                        DrawArrows(firstBeginIndex, firstEndIndex);
                                    }
                                }

                            }

                        }
                    }


                }

            }
            else if(d.r < d.c){ //top right
                DrawPathTwoLines(
                    n2Dx*d.r + n2Dx, //x1
                    n2Dy*d.r + n2Dy * .5, //y1
                    n2Dx*d.c + n2Dx * .5, //right x2
                    n2Dy*d.r + n2Dy * .5, //right y2
                    n2Dx*d.c + n2Dx * .5, //down x3
                    (showParams) ? n2Dy*d.c+1e-2 : n2Dy*boxEnd.startI+1e-2, //down y3
                    RED_ARROW_COLOR, lineWidth, true);
            }
            var leftTextWidthR = d3RightTextNodesArrayZoomed[d.r].nameWidthPx,
                leftTextWidthC = d3RightTextNodesArrayZoomed[d.c].nameWidthPx;
            DrawRect(-leftTextWidthR-PTREE_N2_GAP_PX, n2Dy*d.r, leftTextWidthR, n2Dy, RED_ARROW_COLOR); //highlight var name
            DrawRect(-leftTextWidthC-PTREE_N2_GAP_PX, n2Dy*d.c, leftTextWidthC, n2Dy, GREEN_ARROW_COLOR); //highlight var name
        }


        function MouseoverOnDiagN2(d) {
            //d=hovered element
            var hoveredIndexRC = d.c; //d.x == d.y == row == col
            var leftTextWidthHovered = d3RightTextNodesArrayZoomed[hoveredIndexRC].nameWidthPx;

            // Loop over all elements in the matrix looking for other cells in the same column as
            var lineWidth = Math.min(5, n2Dx * .5, n2Dy * .5);
            arrowMarker.attr("markerWidth", lineWidth * .4)
                .attr("markerHeight", lineWidth * .4);
            DrawRect(-leftTextWidthHovered-PTREE_N2_GAP_PX, n2Dy*hoveredIndexRC, leftTextWidthHovered, n2Dy, HIGHLIGHT_HOVERED_COLOR); //highlight hovered
            for (var i = 0; i < d3RightTextNodesArrayZoomed.length; ++i) {
                var leftTextWidthDependency = d3RightTextNodesArrayZoomed[i].nameWidthPx;
                var box = d3RightTextNodesArrayZoomedBoxInfo[i];
                if(matrix[hoveredIndexRC + "_" + i] !== undefined){ //if (matrix[hoveredIndexRC][i].z > 0) { //i is column here
                    if (i < hoveredIndexRC) { //column less than hovered
                        if(showParams){
                            DrawPathTwoLines(
                                n2Dx*hoveredIndexRC, //x1
                                n2Dy*(hoveredIndexRC+.5), //y1
                                (i+.5)*n2Dx, //left x2
                                n2Dy*(hoveredIndexRC+.5), //left y2
                                (i+.5)*n2Dx, //up x3
                                (i+1)*n2Dy, //up y3
                                GREEN_ARROW_COLOR, lineWidth, true);
                        }
                        else if(i==box.startI){
                            DrawPathTwoLines(
                                n2Dx*hoveredIndexRC, //x1
                                n2Dy*hoveredIndexRC + n2Dy * .5, //y1
                                (box.startI+(box.stopI - box.startI)*.5)*n2Dx + n2Dx*.5, //left x2
                                n2Dy*hoveredIndexRC + n2Dy * .5, //left y2
                                (box.startI+(box.stopI - box.startI)*.5)*n2Dx + n2Dx*.5, //up x3
                                n2Dy*box.stopI + n2Dy, //up y3
                                GREEN_ARROW_COLOR, lineWidth, true);
                        }
                        DrawRect(-leftTextWidthDependency-PTREE_N2_GAP_PX, n2Dy*i, leftTextWidthDependency, n2Dy, GREEN_ARROW_COLOR); //highlight var name

                    } else if (i > hoveredIndexRC) { //column greater than hovered
                        if(showParams){
                            DrawPathTwoLines(
                                n2Dx*hoveredIndexRC + n2Dx, //x1
                                n2Dy*(hoveredIndexRC + .5), //y1
                                (i+.5)*n2Dx, //right x2
                                n2Dy*(hoveredIndexRC + .5), //right y2
                                (i+.5)*n2Dx, //down x3
                                n2Dy*i, //down y3
                                GREEN_ARROW_COLOR, lineWidth, true); //vertical down
                        }
                        else if(i==box.startI){
                            DrawPathTwoLines(
                                n2Dx*hoveredIndexRC + n2Dx, //x1
                                n2Dy*hoveredIndexRC + n2Dy * .5, //y1
                                (box.startI+(box.stopI - box.startI)*.5)*n2Dx + n2Dx*.5, //right x2
                                n2Dy*hoveredIndexRC + n2Dy * .5, //right y2
                                (box.startI+(box.stopI - box.startI)*.5)*n2Dx + n2Dx*.5, //down x3
                                n2Dy*box.startI, //down y3
                                GREEN_ARROW_COLOR, lineWidth, true); //vertical down
                        }
                        DrawRect(-leftTextWidthDependency-PTREE_N2_GAP_PX, n2Dy*i, leftTextWidthDependency, n2Dy, GREEN_ARROW_COLOR); //highlight var name
                    }
                }

                if(matrix[i + "_" + hoveredIndexRC] !== undefined){ //if (matrix[i][hoveredIndexRC].z > 0) { //i is row here
                    if (i < hoveredIndexRC) { //row less than hovered
                        DrawPathTwoLines(
                            n2Dx*i + n2Dx, //x1
                            n2Dy*i + n2Dy * .5, //y1
                            n2Dx*hoveredIndexRC + n2Dx * .5, //right x2
                            n2Dy*i + n2Dy * .5, //right y2
                            n2Dx*hoveredIndexRC + n2Dx * .5, //down x3
                            n2Dy*hoveredIndexRC, //down y3
                            RED_ARROW_COLOR, lineWidth, true); //vertical down
                        DrawRect(-leftTextWidthDependency-PTREE_N2_GAP_PX, n2Dy*i, leftTextWidthDependency, n2Dy, RED_ARROW_COLOR); //highlight var name
                    } else if (i > hoveredIndexRC) { //row greater than hovered
                        DrawPathTwoLines(
                            n2Dx*i, //x1
                            n2Dy*i + n2Dy * .5, //y1
                            n2Dx*hoveredIndexRC + n2Dx * .5, //left x2
                            n2Dy*i + n2Dy * .5, //left y2
                            n2Dx*hoveredIndexRC + n2Dx * .5, //up x3
                            n2Dy*hoveredIndexRC + n2Dy, //up y3
                            RED_ARROW_COLOR, lineWidth, true);
                        DrawRect(-leftTextWidthDependency-PTREE_N2_GAP_PX, n2Dy*i, leftTextWidthDependency, n2Dy, RED_ARROW_COLOR); //highlight var name
                    }
                }
            }
        }

        function MouseoutN2() {
            n2Group.selectAll(".n2_hover_elements").remove();
        }

        function MouseClickN2(d){
            var newClassName = "n2_hover_elements_" + d.r + "_" + d.c;
            var selection = n2Group.selectAll("." + newClassName);
            if(selection.size() > 0){
                selection.remove();
            }
            else{
                n2Group.selectAll("path.n2_hover_elements, circle.n2_hover_elements")
                    .attr("class", newClassName);
            }
        }



        function SetupLegend() {
            var numColumns = 2;
            var elementSize = 30, xOffset = 10, columnWidth = 250;
            var legendWidth = columnWidth*numColumns + 0, legendHeight = 360;
            var u = elementSize * .5;
            var v = u;

            d3.select(d3ContentDiv).select("div.ptN2LegendClass").remove();

            if(!showLegend) return;

            var svg_legend = d3.select(d3ContentDiv).append("div")
                .attr("class", "ptN2LegendClass")
                .style("width", legendWidth + "px")
                .style("height", legendHeight + "px")
                .append("svg:svg")
                .attr("width", legendWidth)
                .attr("height", legendHeight);


            svg_legend.append("rect")
                .attr("class", "background")
                .attr("width", legendWidth)
                .attr("height", legendHeight);
                //.style("fill", "#7f7");



            function CreateElementBorder(g){
                g.append("rect")
                    .attr("x", -u)
                    .attr("y", -v)
                    .attr("width", elementSize)
                    .attr("height", elementSize)
                    .style("stroke-width", 2)
                    .style("stroke", "white")
                    .style("fill", "none");
            }

            function CreateText(g, text){
                g.append("svg:text")
                    .attr("x", u+5)
                    .attr("y", 0)
                    .attr("dy", ".35em")//.attr("dominant-baseline", "middle")//
                    .attr("font-size", 20)
                    .text(text)
                    .style("fill", "black");
            }

            //title LEGEND
            {
                var el = svg_legend.append("g").attr("transform", "translate(" + (legendWidth*.5) + "," + (15) + ")");
                el.append("svg:text")
                    .attr("text-anchor", "middle")
                    .attr("dy", ".35em")//.attr("dominant-baseline", "middle")//
                    .attr("font-size", 30)
                    .attr("text-decoration", "underline")
                    .text("LEGEND")
                    .style("fill", "black");
            }

            //COLUMN TITLES
            {
                var text = ["Colors", "N^2 Symbols"];
                for(var i=0; i<text.length; ++i){
                    var el = svg_legend.append("g").attr("transform", "translate(" + (columnWidth*i+xOffset) + "," + (60) + ")");
                    el.append("svg:text")
                        .attr("dy", ".35em")//.attr("dominant-baseline", "middle")//
                        .attr("font-size", 24)
                        .attr("text-decoration", "underline")
                        .text(text[i])
                        .style("fill", "black");
                }
            }

            //COLORS
            {
                var text = ["Group", "Component", "Unknown Explicit", "Unknown Implicit", "Collapsed", "Connection"];
                var colors = [GROUP_COLOR, COMPONENT_COLOR, UNKNOWN_EXPLICIT_COLOR, UNKNOWN_IMPLICIT_COLOR, COLLAPSED_COLOR, CONNECTION_COLOR];
                if(showParams){
                    text.splice(2,0,"Param");
                    colors.splice(2,0,PARAM_COLOR);
                }
                for(var i=0; i<text.length; ++i){
                    var el = svg_legend.append("g").attr("transform", "translate(" + (columnWidth*0+xOffset+u) + "," + (80+40*i+v) + ")");
                    DrawLegendColor(el,u,v,colors[i],false);
                    CreateText(el, text[i]);
                }
            }

            //N2 SYMBOLS
            {
                var text = ["Scalar", "Vector", "Group"];
                var colors = [UNKNOWN_EXPLICIT_COLOR, UNKNOWN_EXPLICIT_COLOR, UNKNOWN_EXPLICIT_COLOR];
                var shapeFunctions = [DrawScalar, DrawVector, DrawGroup];
                for(var i=0; i<text.length; ++i){
                    var el = svg_legend.append("g").attr("transform", "translate(" + (columnWidth*1+xOffset+u) + "," + (80+40*i+v) + ")");
                    shapeFunctions[i](el,u,v,colors[i],false);
                    CreateElementBorder(el);
                    CreateText(el, text[i]);
                }
            }

        }


        function ReturnToRootButtonClick(){
            backButtonHistory.push({"el" : zoomedElement});
            forwardButtonHistory = [];
            SetupLeftClick(root);
            Update();
        }

        function UpOneLevelButtonClick(){
            if(zoomedElement === root) return;
            backButtonHistory.push({"el" : zoomedElement});
            forwardButtonHistory = [];
            SetupLeftClick(zoomedElement.parent);
            Update();
        }

        function CollapseOutputsButtonClick(startNode) {
            function CollapseOutputs(d){
                if (d.subsystem_type &&  d.subsystem_type === "component") {
                    d.isMinimized = true;
                }
                if(d.children){
                    for (var i = 0; i < d.children.length; ++i) {
                        CollapseOutputs(d.children[i]);
                    }
                }
            }
            FindRootOfChangeFunction = FindRootOfChangeForCollapseUncollapseOutputs;
            TRANSITION_DURATION = TRANSITION_DURATION_SLOW;
            lastClickWasLeft = false;
            CollapseOutputs(startNode);
            Update();
        }

        function UncollapseButtonClick(startNode) {
            function Uncollapse(d){
                if(d.type !== "param") {
                    d.isMinimized = false;
                }
                if(d.children){
                    for (var i = 0; i < d.children.length; ++i) {
                        Uncollapse(d.children[i]);
                    }
                }
            }
            FindRootOfChangeFunction = FindRootOfChangeForCollapseUncollapseOutputs;
            TRANSITION_DURATION = TRANSITION_DURATION_SLOW;
            lastClickWasLeft = false;
            Uncollapse(startNode);
            Update();
        }

        function CollapseToDepthSelectChange(newChosenCollapseDepth){
            function CollapseToDepth(d,depth){
                if(d.type === "param" || d.type === "unknown") {
                    return;
                }
                if (d.depth < depth) {
                    d.isMinimized = false;
                }
                else {
                    d.isMinimized = true;
                }
                if(d.children){
                    for (var i = 0; i < d.children.length; ++i) {
                        CollapseToDepth(d.children[i],depth);
                    }
                }
            }

            chosenCollapseDepth = newChosenCollapseDepth;
            if(chosenCollapseDepth > zoomedElement.depth){
                CollapseToDepth(root,chosenCollapseDepth);
            }
            FindRootOfChangeFunction = FindRootOfChangeForCollapseDepth;
            TRANSITION_DURATION = TRANSITION_DURATION_SLOW;
            lastClickWasLeft = false;
            Update();
        }

        function FontSizeSelectChange(fontSize){
            for(var i=8; i<=14; ++i) {
                var newText = (i == fontSize) ? ("<b>" + i + "px</b>" ) : (i + "px");
                parentDiv.querySelector("#idFontSize" + i + "px"+uniqueId).innerHTML = newText;
            }
            FONT_SIZE_PX = fontSize;
            TRANSITION_DURATION = TRANSITION_DURATION_FAST;
            UpdateSvgCss();
            Update();
        }

        function VerticalResize(height) {
            for(var i=600; i<=1000; i+=50) {
                var newText = (i == height) ? ("<b>" + i + "px</b>" ) : (i + "px");
                parentDiv.querySelector("#idVerticalResize" + i + "px"+uniqueId).innerHTML = newText;
            }
            ClearArrowsAndConnects();
            HEIGHT_PX = height;
            LEVEL_OF_DETAIL_THRESHOLD = HEIGHT_PX / 3;
            WIDTH_N2_PX = HEIGHT_PX;
            TRANSITION_DURATION = TRANSITION_DURATION_FAST;
            UpdateSvgCss();
            Update();
        }

        /*function OutputNameSelectChange(){
            if(outputNamingType !== outputNamingSelectElement.value){
                outputNamingType = outputNamingSelectElement.value;
                Update();
            }

            outputNamingSelectElement.selectedIndex = 0;
            outputNamingFirstOption.text = "Output Naming (" + outputNamingType + ")";
        }*/

        function ShowParamsCheckboxChange(){
            if(zoomedElement.type === "param") return;
            showParams = !showParams;
            parentDiv.querySelector("#showParamsButtonId"+uniqueId).className = showParams ? "myButton myButtonToggledOn" : "myButton";

            FindRootOfChangeFunction = FindRootOfChangeForShowParams;
            lastClickWasLeft = false;
            TRANSITION_DURATION = TRANSITION_DURATION_SLOW;
            transitionStartDelay = 500;
            SetupLegend();
            Update();

        }


        function ShowPathCheckboxChange(){
            showPath = !showPath;
            parentDiv.querySelector("#currentPathId"+uniqueId).style.display = showPath ? "block" : "none";
            parentDiv.querySelector("#showCurrentPathButtonId"+uniqueId).className = showPath ? "myButton myButtonToggledOn" : "myButton";
        }

        function ToggleLegend(){
            showLegend = !showLegend;
            parentDiv.querySelector("#showLegendButtonId"+uniqueId).className = showLegend ? "myButton myButtonToggledOn" : "myButton";
            SetupLegend();
        }


        function SaveSvg(){
            //get svg element.
            var svgData = parentDiv.querySelector("#svgId"+uniqueId).outerHTML;

            //add name spaces.
            if(!svgData.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){
                svgData = svgData.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
            }
            if(!svgData.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)){
                svgData = svgData.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
            }

            //add xml declaration
            svgData = '<?xml version="1.0" standalone="no"?>\r\n' + svgData;

            svgData = vkbeautify.xml(svgData);
            var svgBlob = new Blob([svgData], {type:"image/svg+xml;charset=utf-8"});
            var svgUrl = URL.createObjectURL(svgBlob);
            var downloadLink = document.createElement("a");
            downloadLink.href = svgUrl;
            downloadLink.download = "partition_tree_n2.svg";
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        function CreateDomLayout() {
            parentDiv.innerHTML =
                "<!-- The Modal -->" +
                "<div id=\"myModal"+uniqueId+"\" class=\"modal\">" +
                "    <!-- Modal content -->" +
                "    <div class=\"modal-content\">" +
                "        <div class=\"modal-header\">" +
                "            <span id=\"idSpanModalClose"+uniqueId+"\" class=\"close\"></span>" +
                "            Instructions" +
                "        </div>" +
                "        <div class=\"modal-body\">" +
                "            <p>Left clicking on a node in the partition tree will navigate to that node." +
                "            Right clicking on a node in the partition tree will collapse/uncollapse it." +
                "            A click on any element in the N^2 diagram will allow those arrows to persist.</p>" +
                "        </div>" +
                "        <div class=\"modal-footer\">" +
                "            OpenMDAO Partition Tree and N^2 diagram." +
                "        </div>" +
                "    </div>" +
                "</div>" +
                "<div id=\"toolbarLoc"+uniqueId+"\"></div>" +
                "<div style=\"margin-top:5px;\">" +
                "    <input type=\"text\" id=\"awesompleteId"+uniqueId+"\" size=\"80\" />" +
                "    <button class=\"myButton\" id=\"searchButtonId"+uniqueId+"\" title=\"Search\"><i class=\"icon-search\"></i></button>" +
                "    <label id=\"searchCountId"+uniqueId+"\" style=\"display:inline-block;width:120px\"></label>" +
                "</div>" +
                "<!--<select id=\"outputNamingSelect\" onchange=\"OutputNameSelectChange()\" style=\"display:none\">-->" +
                "<div id=\"currentPathId"+uniqueId+"\" class=\"path_string\" style=\"display:none\"></div>" +
                "<div id=\"d3_content_div"+uniqueId+"\"></div>" +
                "<div id=\"connectionId"+uniqueId+"\"></div>";

            parentDiv.querySelector("#searchButtonId"+uniqueId).onclick = SearchButtonClicked;


        }

        function CreateToolbar() {
            var placeToAdd = parentDiv.querySelector("#toolbarLoc"+uniqueId);
            var div = document.createElement("div");
            div.className = "toolbar";
            div.innerHTML =
                "<div class=\"button-group\">" +
                "    <button class=\"myButton\" id=\"returnToRootButtonId"+uniqueId+"\" disabled=\"disabled\" title=\"Return To Root\">" +
                "        <i class=\"icon-home\"></i>" +
                "    </button>" +
                "    <button class=\"myButton\" id=\"backButtonId"+uniqueId+"\" disabled=\"disabled\" title=\"Back\">" +
                "        <i class=\"icon-left-big\"></i>" +
                "    </button>" +
                "    <button class=\"myButton\" id=\"forwardButtonId"+uniqueId+"\" disabled=\"disabled\" title=\"Forward\">" +
                "        <i class=\"icon-right-big\"></i>" +
                "    </button>" +
                "    <button class=\"myButton\" id=\"upOneLevelButtonId"+uniqueId+"\" disabled=\"disabled\" title=\"Up One Level\">" +
                "        <i class=\"icon-up-big\"></i>" +
                "    </button>" +
                "</div>" +
                "<div class=\"button-group\">" +
                "    <button class=\"myButton\" id=\"uncollapseInViewButtonId"+uniqueId+"\" title=\"Uncollapse In View Only\">" +
                "        <i class=\"icon-resize-full\"></i>" +
                "    </button>" +
                "    <button class=\"myButton\" id=\"uncollapseAllButtonId"+uniqueId+"\" title=\"Uncollapse All\">" +
                "        <i class=\"icon-resize-full bigger-font\"></i>" +
                "    </button>" +
                "    <button class=\"myButton\" id=\"collapseInViewButtonId"+uniqueId+"\" title=\"Collapse Outputs In View Only\">" +
                "        <i class=\"icon-resize-small\"></i>" +
                "    </button>" +
                "    <button class=\"myButton\" id=\"collapseAllButtonId"+uniqueId+"\" title=\"Collapse All Outputs\">" +
                "        <i class=\"icon-resize-small bigger-font\"></i>" +
                "    </button>" +
                "    <div class=\"dropdown\">" +
                "        <button class=\"myButton\" title=\"Collapse Depth\">" +
                "            <i class=\"icon-sort-number-up\"></i>" +
                "        </button>" +
                "        <div id=\"idCollapseDepthDiv"+uniqueId+"\" class=\"dropdown-content\">" +
                "            <span class=\"fakeLink\">Collapse Depth</span>" +
                "        </div>" +
                "    </div>" +
                "</div>" +
                "<div class=\"button-group\">" +
                "    <button class=\"myButton\" id=\"clearArrowsAndConnectsButtonId"+uniqueId+"\" title=\"Clear Arrows and Connections\">" +
                "        <i class=\"icon-eraser\"></i>" +
                "    </button>" +
                "    <button class=\"myButton\" id=\"showCurrentPathButtonId"+uniqueId+"\" title=\"Show Path\">" +
                "        <i class=\"icon-terminal\"></i>" +
                "    </button>" +
                "    <button class=\"myButton\" id=\"showLegendButtonId"+uniqueId+"\" title=\"Show Legend\">" +
                "        <i class=\"icon-map-signs\"></i>" +
                "    </button>" +
                "    <button class=\"myButton\" id=\"showParamsButtonId"+uniqueId+"\" type=\"checkbox\" title=\"Show Params\">" +
                "        <i class=\"icon-exchange\"></i>" +
                "    </button>" +
                "    <div class=\"dropdown\">" +
                "        <button class=\"myButton\" title=\"Font Size\">" +
                "            <i class=\"icon-text-height\"></i>" +
                "        </button>" +
                "        <div class=\"dropdown-content\">" +
                "            <span class=\"fakeLink\">Font Size</span>" +
                "            <span class=\"fakeLink\" id=\"idFontSize8px"+uniqueId+"\">8px</span>" +
                "            <span class=\"fakeLink\" id=\"idFontSize9px"+uniqueId+"\">9px</span>" +
                "            <span class=\"fakeLink\" id=\"idFontSize10px"+uniqueId+"\">10px</span>" +
                "            <span class=\"fakeLink\" id=\"idFontSize11px"+uniqueId+"\"><b>11px</b></span>" +
                "            <span class=\"fakeLink\" id=\"idFontSize12px"+uniqueId+"\">12px</span>" +
                "            <span class=\"fakeLink\" id=\"idFontSize13px"+uniqueId+"\">13px</span>" +
                "            <span class=\"fakeLink\" id=\"idFontSize14px"+uniqueId+"\">14px</span>" +
                "        </div>" +
                "    </div>" +
                "    <div class=\"dropdown\">" +
                "        <button class=\"myButton\" title=\"Vertically Resize\">" +
                "            <i class=\"icon-resize-vertical\"></i>" +
                "        </button>" +
                "        <div class=\"dropdown-content\">" +
                "            <span class=\"fakeLink\">Model Height</span>" +
                "            <span class=\"fakeLink\" id=\"idVerticalResize600px"+uniqueId+"\"><b>600px</b></span>" +
                "            <span class=\"fakeLink\" id=\"idVerticalResize650px"+uniqueId+"\">650px</span>" +
                "            <span class=\"fakeLink\" id=\"idVerticalResize700px"+uniqueId+"\">700px</span>" +
                "            <span class=\"fakeLink\" id=\"idVerticalResize750px"+uniqueId+"\">750px</span>" +
                "            <span class=\"fakeLink\" id=\"idVerticalResize800px"+uniqueId+"\">800px</span>" +
                "            <span class=\"fakeLink\" id=\"idVerticalResize850px"+uniqueId+"\">850px</span>" +
                "            <span class=\"fakeLink\" id=\"idVerticalResize900px"+uniqueId+"\">900px</span>" +
                "            <span class=\"fakeLink\" id=\"idVerticalResize950px"+uniqueId+"\">950px</span>" +
                "            <span class=\"fakeLink\" id=\"idVerticalResize1000px"+uniqueId+"\">1000px</span>" +
                "        </div>" +
                "    </div>" +
                "</div>" +
                "<div class=\"button-group\">" +
                "    <button class=\"myButton\" id=\"saveSvgButtonId"+uniqueId+"\" title=\"Save SVG\">" +
                "        <i class=\"icon-floppy\"></i>" +
                "    </button>" +
                "</div>" +
                "<div class=\"button-group\">" +
                "    <button class=\"myButton\" id=\"helpButtonId"+uniqueId+"\" title=\"Help\">" +
                "        <i class=\"icon-help\"></i>" +
                "    </button>" +
                "</div>";

            placeToAdd.appendChild(div);


            div.querySelector("#returnToRootButtonId"+uniqueId).onclick = ReturnToRootButtonClick;
            div.querySelector("#backButtonId"+uniqueId).onclick = BackButtonPressed;
            div.querySelector("#forwardButtonId"+uniqueId).onclick = ForwardButtonPressed;
            div.querySelector("#upOneLevelButtonId"+uniqueId).onclick = UpOneLevelButtonClick;
            div.querySelector("#uncollapseInViewButtonId"+uniqueId).onclick = function(){UncollapseButtonClick(zoomedElement);};
            div.querySelector("#uncollapseAllButtonId"+uniqueId).onclick = function(){UncollapseButtonClick(root);};
            div.querySelector("#collapseInViewButtonId"+uniqueId).onclick = function(){CollapseOutputsButtonClick(zoomedElement);};
            div.querySelector("#collapseAllButtonId"+uniqueId).onclick = function(){CollapseOutputsButtonClick(root);};
            div.querySelector("#clearArrowsAndConnectsButtonId"+uniqueId).onclick = ClearArrowsAndConnects;
            div.querySelector("#showCurrentPathButtonId"+uniqueId).onclick = ShowPathCheckboxChange;
            div.querySelector("#showLegendButtonId"+uniqueId).onclick = ToggleLegend;
            div.querySelector("#showParamsButtonId"+uniqueId).onclick = ShowParamsCheckboxChange;

            for(var i=8; i<=14; ++i){
                var f = function(idx) {
                    return function(){FontSizeSelectChange(idx);};
                }(i);
                div.querySelector("#idFontSize"+i+"px"+uniqueId).onclick = f;
            }

            for(var i=600; i<=1000; i+=50){
                var f = function(idx) {
                    return function(){VerticalResize(idx);};
                }(i);
                div.querySelector("#idVerticalResize"+i+"px"+uniqueId).onclick = f;
            }

            div.querySelector("#saveSvgButtonId"+uniqueId).onclick = SaveSvg;
            div.querySelector("#helpButtonId"+uniqueId).onclick = DisplayModal;



        }

        return {
            GetFontSize : function(){return FONT_SIZE_PX;},
            ResizeHeight: function(h){VerticalResize(h);},
            Redraw: function(){Update();}
        };
    }



    var rootJson = % s;
    var connsJson = % s;



    var app = PtN2Diagram(document.getElementById("ptN2ContentDivId"), "aaa", rootJson, connsJson);



    </script>
% s
