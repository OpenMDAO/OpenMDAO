name: OpenMDAO Docs (pixi)

on:
  # Trigger on push or pull request events for the master branch
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

  # Trigger on release, to publish release versioned docs to openmdao.org
  release:
    types: [published]

  # Allow running the workflow manually from the Actions tab
  # All jobs are included by default and may be deselected if desired
  workflow_dispatch:

    inputs:

      run_name:
        type: string
        description: 'Name of workflow run as it will appear under Actions tab:'
        required: false
        default: ""

      debug_enabled:
        type: boolean
        description: 'Run the build with tmate debugging enabled (https://github.com/marketplace/actions/debugging-with-tmate)'
        required: false
        default: false

concurrency:
  # Cancel any existing CI runs if we push to this branch
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

run-name:  ${{ inputs.run_name }}

permissions: {}

jobs:

  tests:

    timeout-minutes: 120

    strategy:
      fail-fast: false
      matrix:
        include:
          # test baseline versions on Ubuntu
          - NAME: Ubuntu py313
            OS: ubuntu-24.04
            PUBLISH: true
            PIXI_ENVIRONMENT: dev
            SNOPT: true

    runs-on: ${{ matrix.OS }}

    name: ${{ matrix.NAME }}

    defaults:
      run:
        # Note this isn't passed to the composite action
        shell: bash -l {0}

    steps:

      - name: Checkout code
        uses: actions/checkout@v6

      - name: 'Setup OpenMDAO pixi Environment'
        id: setup_pixi_environment
        uses: ./.github/actions/setup_openmdao_pixi
        with:
          environment: '${{ matrix.PIXI_ENVIRONMENT }}'
          openmdao_install_from: 'wheel'

      - name: Check SNOPT availability
        id: check_snopt
        run: |
          if [[ "${{ matrix.PIXI_ENVIRONMENT }}" != "minimal" ]] && [[ "${{ matrix.SNOPT }}" == "true" ]] && [[ "${{ secrets.SNOPT_LOCATION_77 }}" != "" ]]; then
            echo "should_run_snopt=true" >> $GITHUB_OUTPUT
            echo "SNOPT is enabled and secrets are available"
          else
            echo "should_run_snopt=false" >> $GITHUB_OUTPUT
            if [[ "${{ matrix.SNOPT }}" == "true" ]]; then
              if [[ "${{ matrix.PIXI_ENVIRONMENT }}" == "minimal" ]]; then
                echo "SNOPT is enabled but minimal environment is not supported"
              elif [[ "${{ secrets.SNOPT_LOCATION_77 }}" == "" ]]; then
                echo "SNOPT is enabled but secrets are not available - skipping SNOPT steps"
              fi
            else
              echo "SNOPT is disabled in matrix"
            fi
          fi

      - name: Create SSH key
        if: steps.check_snopt.outputs.should_run_snopt == 'true' && runner.os != 'Windows'
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
        run: |
          eval "$(pixi shell-hook -e ${{ matrix.PIXI_ENVIRONMENT }})"
          mkdir -p ~/.ssh/
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts

      - name: Install compilers
        if: steps.check_snopt.outputs.should_run_snopt == 'true' && runner.os != 'Windows'
        run: |
          eval "$(pixi shell-hook -e ${{ matrix.PIXI_ENVIRONMENT }})"
          echo "============================================================="
          echo "Install compilers"
          echo "============================================================="
          if [[  "${{ matrix.OS }}" != "macos-15" ]]; then
            pixi add cython swig compilers cmake meson
          else
            pixi add cython swig compilers cmake meson
          fi

      - uses: fortran-lang/setup-fortran@v1
        id: setup-fortran
        if: steps.check_snopt.outputs.should_run_snopt == 'true' && runner.os == 'Windows'
        with:
          compiler: intel
          version: 2025.2

      - name: Install build_pyoptsparse
        if: steps.check_snopt.outputs.should_run_snopt == 'true'
        run: |
          echo "============================================================="
          echo "Install build_pyoptsparse in pixi environment"
          echo "============================================================="
          eval "$(pixi shell-hook -e ${{ matrix.PIXI_ENVIRONMENT }})"
          pip install . git+https://github.com/OpenMDAO/build_pyoptsparse.git

      - name: Copy SNOPT source files
        if: steps.check_snopt.outputs.should_run_snopt == 'true'
        run: |
          echo "============================================================="
          echo "Copying SNOPT 7.7 source files via SSH"
          echo "============================================================="
          mkdir -p SNOPT
          scp -qr ${{ secrets.SNOPT_LOCATION_77 }} SNOPT
          ls -la SNOPT/src

      - name: Build SNOPT module
        if: steps.check_snopt.outputs.should_run_snopt == 'true'
        env:
          FC: ${{ runner.os == 'Windows' && 'ifx' || 'gfortran' }}
          CC: ${{ runner.os == 'Windows' && 'cl' || 'gcc' }}
        run: |
          echo "============================================================="
          echo "Build SNOPT module with build_pyoptsparse"
          echo "============================================================="
          eval "$(pixi shell-hook -e ${{ matrix.PIXI_ENVIRONMENT }})"
          python -m build_pyoptsparse.snopt_module SNOPT/src

      - name: 'Build and Optionally Publish Docs'
        id: build_docs
        uses: ./.github/actions/build_docs
        with:
          matrix_name: ${{ matrix.NAME }}
          use_snopt: ${{ format('{0}', matrix.SNOPT != '') }}
          SECRET_docs_location: ${{ secrets.DOCS_LOCATION }}
          SECRET_slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          publish: ${{ matrix.PUBLISH }}
          use_pixi: 'true'
